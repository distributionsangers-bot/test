<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>COP1 Angers - Espace B√©n√©voles</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <script type="text/javascript">
        function googleTranslateElementInit() {
            new google.translate.TranslateElement({ pageLanguage: 'fr', includedLanguages: 'en,fr', autoDisplay: false }, 'google_translate_element');
        }
        function toggleLanguage() {
            const currentCookie = document.cookie.split('; ').find(row => row.startsWith('googtrans='));
            const isEnglish = currentCookie && currentCookie.includes('/fr/en');
            document.cookie = isEnglish ? "googtrans=/fr/fr; domain=" + window.location.hostname + "; path=/" : "googtrans=/fr/en; domain=" + window.location.hostname + "; path=/";
            window.location.reload();
        }
    </script>
    <script type="text/javascript"
        src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    colors: {
                        brand: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 900: '#1e3a8a' },
                    },
                    animation: { 'fade-in': 'fadeIn 0.3s ease-out', 'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1)', 'scan': 'scan 2s linear infinite' },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } },
                        scan: { '0%': { transform: 'translateY(0)' }, '100%': { transform: 'translateY(16rem)' } }
                    }
                }
            }
        }
    </script>

    <style>
        /* CORRECTION : Suppression du blocage de scroll agressif sur le body */
        body {
            background-color: #F8FAFC;
            min-height: 100vh;
            /* Laisser le scroll natif sauf si une modale est ouverte */
        }

        .goog-te-banner-frame,
        .goog-te-gadget-icon,
        .goog-te-gadget-simple,
        .skiptranslate {
            display: none !important;
        }

        body>.skiptranslate {
            display: none !important;
        }

        #toast-container {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10000;
            width: 90%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            pointer-events: none;
        }

        .toast {
            pointer-events: auto;
            background: white;
            padding: 1rem;
            border-radius: 1rem;
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: slideDown 0.3s ease;
            border-left: 4px solid #2563eb;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        input[type="file"]::file-selector-button {
            display: none;
        }

        /* Utilitaires pour cacher la scrollbar */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Padding safe area pour iPhone X+ */
        .pt-safe {
            padding-top: env(safe-area-inset-top);
        }

        .pb-safe {
            padding-bottom: env(safe-area-inset-bottom);
        }
    </style>
</head>

<body class="text-slate-800 antialiased selection:bg-brand-100 selection:text-brand-900">

    <div id="toast-container"></div>

    <div id="google_translate_element" style="display:none"></div>

    <div id="root" class="h-full w-full relative text-slate-800 antialiased bg-[#F8FAFC]"></div>

    <div id="global-loader"
        class="fixed inset-0 bg-white z-[9999] flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="w-16 h-16 border-4 border-brand-100 border-t-brand-600 rounded-full animate-spin"></div>
    </div>

    <script>
        // ============================================================
        // 1. CONFIG
        // ============================================================
        const SUPABASE_URL = "https://byudwucohomcgzmercyg.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ5dWR3dWNvaG9tY2d6bWVyY3lnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MDE3OTcsImV4cCI6MjA4MDE3Nzc5N30.9our8e-wE84GiavUv8myX5iKP-dxVdg0vNB0aWScFvI";
        const BUCKET_PROOF = "proofs";
        const LOGO_URL = "logo.png";

        let supabase, html5QrcodeScanner = null;
        const state = {
            user: null, profile: null, view: 'login', adminMode: false,
            events: [], myRegs: [], usersToValidate: [], allUsers: [], messages: [],
            admins: [], templates: [], tempShifts: [], teams: [], myInterests: [],
            dashboard: { totalVolunteers: 0, totalHours: 0, pendingCount: 0, urgentShifts: [] },
            planningTab: 'upcoming',
            proofs: {} // <-- map user_id -> latest proof path
        };

        // ============================================================
        // 2. UTILS
        // ============================================================
        // Fonction pour s√©curiser le texte (emp√™che les failles XSS)
        function escapeHtml(text) {
            if (!text) return text;
            return text
                .toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function showToast(msg, type = 'success') {
            const container = document.getElementById('toast-container');

            // Configuration des styles selon le type
            const styles = {
                success: { bg: 'bg-white', border: 'border-brand-500', text: 'text-slate-800', icon: 'check-circle-2', iconColor: 'text-brand-500' },
                error: { bg: 'bg-white', border: 'border-red-500', text: 'text-red-600', icon: 'alert-circle', iconColor: 'text-red-500' },
                warning: { bg: 'bg-white', border: 'border-orange-400', text: 'text-orange-600', icon: 'alert-triangle', iconColor: 'text-orange-400' }
            };

            const s = styles[type] || styles.success;

            const el = document.createElement('div');
            el.className = `toast ${s.bg} ${s.text} border-l-4 ${s.border} p-4 rounded-xl shadow-2xl flex items-center gap-3 transform transition-all duration-300 translate-y-[-20px] opacity-0 mb-3 min-w-[300px]`;

            el.innerHTML = `
                <i data-lucide="${s.icon}" class="w-6 h-6 ${s.iconColor} flex-shrink-0"></i>
                <span class="font-bold text-sm">${msg}</span>
            `;

            container.appendChild(el);
            lucide.createIcons();

            // Animation Entr√©e
            requestAnimationFrame(() => {
                el.style.transform = 'translateY(0)';
                el.style.opacity = '1';
            });

            // Suppression Auto
            setTimeout(() => {
                el.style.opacity = '0';
                el.style.transform = 'translateY(-20px)';
                setTimeout(() => el.remove(), 300);
            }, 4000);
        }

        function toggleLoader(show) {
            const el = document.getElementById('global-loader');

            // S√âCURIT√â : Si l'√©l√©ment n'existe pas, on arr√™te tout pour √©viter le crash
            if (!el) {
                console.warn("‚ö†Ô∏è Attention : l'√©l√©ment #global-loader est introuvable dans le HTML.");
                return;
            }

            if (show) {
                el.style.display = 'flex';
                // Petit d√©lai pour l'animation
                setTimeout(() => { if (el) el.style.opacity = 1; }, 10);
            } else {
                el.style.opacity = 0;
                setTimeout(() => { if (el) el.style.display = 'none'; }, 500);
            }
        }

        // ============================================================
        // 3. CORE LOGIC
        // ============================================================
        async function initApp() {
            // 1. Initialisation de Supabase
            const { createClient } = window.supabase;
            supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

            // 2. Gestion du rafra√Æchissement intelligent (Anti-clignotement)
            let refreshTimer;
            const triggerRefresh = () => {
                clearTimeout(refreshTimer);
                refreshTimer = setTimeout(() => {
                    console.log('üîÑ Rafra√Æchissement de la vue...');
                    const main = document.getElementById('main-slot');
                    if (!main) return;

                    if (state.view === 'events') renderEvents(main);
                    else if (state.view === 'dashboard') renderDashboard(main);
                    else if (state.view === 'admin_events') renderPlanningAdmin(main);
                    else if (state.view === 'admin_users') renderAnnuaire(main);
                    else if (state.view === 'profile') loadUserProfile().then(() => renderProfile(main));
                    else if (state.view === 'messages') renderMessages(main); // Ajout pour le chat
                    else if (state.view === 'poles') renderPoles(main);       // Ajout pour les p√¥les
                }, 300);
            };

            // 3. √âcoute des changements DB
            supabase.channel('global-app-changes')
                .on('postgres_changes', { event: '*', schema: 'public' }, () => triggerRefresh())
                .subscribe();

            // 4. V√âRIFICATION DE LA SESSION (C'est ici que tout se joue)
            const { data: { session } } = await supabase.auth.getSession();

            if (session) {
                state.user = session.user;

                // Chargement des donn√©es
                await Promise.all([loadUserProfile(), loadBackgroundData()]);

                // --- LOGIQUE DE REDIRECTION ---

                if (state.profile?.status === 'pending') {
                    renderPendingView();
                }
                else if (state.profile?.status === 'rejected') {
                    renderRejectedView();
                }
                else {
                    // Utilisateur valid√© : on lance l'app
                    renderAppShell();

                    // A. Restauration du Mode Admin
                    if (state.profile?.is_admin) {
                        // On regarde si une pr√©f√©rence est sauvegard√©e
                        const savedMode = localStorage.getItem('cop1_admin_mode');
                        // Si 'false' est √©crit, on met false. Sinon (si 'true' ou vide), on met true.
                        state.adminMode = savedMode !== 'false';
                    } else {
                        // Si pas admin, forc√© √† false
                        state.adminMode = false;
                    }

                    // B. Restauration de la Vue
                    const lastView = localStorage.getItem('cop1_last_view');

                    if (lastView) {
                        // Si on a une vue en m√©moire (ex: on a fait F5 sur l'annuaire), on y retourne
                        setView(lastView);
                    } else {
                        // Sinon, vue par d√©faut selon le r√¥le
                        // Admin -> Dashboard
                        // B√©n√©vole -> Events (Missions)
                        setView(state.adminMode ? 'dashboard' : 'events');
                    }
                }

                toggleLoader(false);
            } else {
                // Pas de session
                renderLogin();
                toggleLoader(false);
            }

            // V√©rification cookies
            checkCookieConsent();

            // 5. √âcoute des changements de connexion
            supabase.auth.onAuthStateChange(async (event, session) => {
                if (event === 'SIGNED_IN' && (!state.user || session?.user.id !== state.user?.id)) {
                    window.location.reload(); // On recharge pour appliquer proprement la logique ci-dessus
                } else if (event === 'SIGNED_OUT') {
                    state.user = null;
                    state.profile = null;
                    renderLogin();
                }
            });
        }
        async function loadBackgroundData() {
            await Promise.all([loadTeams()]);
            if (state.profile?.is_admin) { loadAdmins(); loadTemplates(); }
        }

        // REMPLACER LA FONCTION loadUserProfile PAR CELLE-CI :
        async function loadUserProfile() {
            try {
                const { data: profile, error } = await supabase
                    .from('profiles')
                    .select('*') // Selectionne tout, y compris total_hours calcul√©
                    .eq('id', state.user.id)
                    .single();

                if (error) throw error;

                state.profile = profile;

                // Mise √† jour UI Profil
                const container = document.getElementById('profile-info');
                if (container) {
                    // Affichage propre du statut
                    let statusBadge = '';
                    if (profile.status === 'pending') statusBadge = '<span class="px-2 py-1 rounded bg-yellow-100 text-yellow-800 text-sm">En attente</span>';
                    else if (profile.status === 'approved') statusBadge = '<span class="px-2 py-1 rounded bg-green-100 text-green-800 text-sm">Valid√©</span>';
                    else statusBadge = '<span class="px-2 py-1 rounded bg-red-100 text-red-800 text-sm">Refus√©</span>';

                    container.innerHTML = `
                <div class="flex items-center space-x-4 mb-6">
                    <div class="w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center text-white text-2xl font-bold">
                        ${profile.first_name ? profile.first_name[0] : '?'}
                    </div>
                    <div>
                        <h2 class="text-xl font-bold">${profile.first_name} ${profile.last_name}</h2>
                        <p class="text-gray-500 text-sm">${profile.email}</p>
                        <div class="mt-1">${statusBadge}</div>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4 text-center">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <div class="text-2xl font-bold text-blue-600">${profile.total_hours || 0}h</div>
                        <div class="text-xs text-gray-500 uppercase font-semibold">Total Heures</div>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-lg">
                         <div class="text-xl font-bold text-purple-600">
                            ${profile.mandatory_hours ? 'SCOLAIRE' : 'STANDARD'}
                         </div>
                        <div class="text-xs text-gray-500 uppercase font-semibold">Statut</div>
                    </div>
                </div>
            `;
                }

                // CORRECTION : Suppression du bloc "nav-admin" qui faisait planter le site
                // La gestion du menu admin se fait d√©j√† automatiquement dans updateNavUI()

            } catch (err) {
                console.error("Erreur chargement profil", err);
            }
        }

        // ============================================================
        // 4. VIEWS & RENDER
        // ============================================================
        function renderLogin() {
            document.getElementById('root').innerHTML = `
        <div class="h-full w-full bg-white overflow-y-auto scroll-smooth">
            
            <div class="min-h-full flex flex-col justify-center px-6 py-10 max-w-md mx-auto">
            
                <div class="text-center mb-8"> 
                    <img src="${LOGO_URL}" class="w-20 h-20 mx-auto mb-4 object-contain">
                    <h1 class="text-3xl font-extrabold text-slate-900">Espace B√©n√©voles</h1>
                    <p class="text-slate-500">COP1 Angers</p>
                </div>
                
                <div class="bg-slate-50 p-1 rounded-xl mb-6 flex shrink-0">
                    <button onclick="toggleAuth('login')" id="tab-login" class="flex-1 py-3 rounded-lg text-sm font-bold bg-white text-brand-600 shadow-sm transition">Connexion</button>
                    <button onclick="toggleAuth('register')" id="tab-register" class="flex-1 py-3 rounded-lg text-sm font-bold text-slate-400 hover:text-slate-600 transition">Inscription</button>
                </div>

                <form id="form-login" onsubmit="handleLogin(event)" class="space-y-4 animate-fade-in">
                    <input id="login-email" type="email" required class="w-full px-5 py-4 bg-slate-50 rounded-2xl font-bold outline-none focus:ring-2 focus:ring-brand-500" placeholder="Email">
                    <input id="login-password" type="password" required class="w-full px-5 py-4 bg-slate-50 rounded-2xl font-bold outline-none focus:ring-2 focus:ring-brand-500" placeholder="Mot de passe">
                    <button type="submit" class="w-full py-4 bg-brand-600 text-white font-bold rounded-2xl shadow-lg active:scale-95 transition">Se connecter</button>
                    <button type="button" onclick="openForgotPasswordModal()" class="w-full text-xs font-bold text-slate-400">Mot de passe oubli√© ?</button>
                    
                    <div class="pt-8 text-center flex justify-center gap-4 text-[10px] text-slate-400 font-bold">
                        <button type="button" onclick="setView('mentions')">Mentions</button> ‚Ä¢
                        <button type="button" onclick="setView('privacy')">Donn√©es</button> ‚Ä¢
                        <button type="button" onclick="setView('cgu')">CGU</button>
                    </div>
                </form>

                <form id="form-register" onsubmit="handleRegister(event)" class="space-y-3 hidden animate-fade-in pb-4">
                    <div class="grid grid-cols-2 gap-3">
                        <input id="reg-fn" type="text" placeholder="Pr√©nom" required class="w-full px-4 py-3 bg-slate-50 rounded-xl font-bold">
                        <input id="reg-ln" type="text" placeholder="Nom" required class="w-full px-4 py-3 bg-slate-50 rounded-xl font-bold">
                    </div>
                    <input id="reg-email" type="email" placeholder="Email" required class="w-full px-4 py-3 bg-slate-50 rounded-xl font-bold">
                    <input id="reg-phone" type="tel" placeholder="T√©l√©phone" required class="w-full px-4 py-3 bg-slate-50 rounded-xl font-bold">
                    <input id="reg-pass" type="password" placeholder="Mot de passe" required class="w-full px-4 py-3 bg-slate-50 rounded-xl font-bold">
                    
                    <label class="flex items-center gap-3 p-3 bg-white border border-slate-100 rounded-xl cursor-pointer">
                        <input type="checkbox" id="reg-permit" class="w-5 h-5 text-brand-600 rounded">
                        <span class="text-sm font-bold text-slate-600">J'ai le Permis B üöó</span>
                    </label>

                    <div class="mb-4">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1">Justificatif (Carte √âtudiant)</label>
                        
                        <div onclick="document.getElementById('reg-proof').click()" id="upload-zone" class="relative group cursor-pointer bg-slate-50 hover:bg-white border-2 border-dashed border-slate-300 hover:border-brand-500 rounded-2xl p-6 transition-all text-center">
                            
                            <input id="reg-proof" type="file" required accept="image/*,.pdf" class="hidden" onchange="handleFileSelect(this)">
                            
                            <div id="upload-default" class="flex flex-col items-center gap-2">
                                <div class="w-12 h-12 bg-white rounded-full shadow-sm flex items-center justify-center text-brand-600 group-hover:scale-110 transition">
                                    <i data-lucide="cloud-upload" class="w-6 h-6"></i>
                                </div>
                                <div>
                                    <p class="text-sm font-bold text-slate-700">Cliquez pour ajouter</p>
                                    <p class="text-[10px] text-slate-400 font-medium mt-1">PDF, JPG ou PNG (Max 5 Mo)</p>
                                </div>
                            </div>

                            <div id="upload-success" class="hidden flex-col items-center gap-2 animate-fade-in">
                                <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center text-green-600">
                                    <i data-lucide="check" class="w-6 h-6"></i>
                                </div>
                                <div>
                                    <p class="text-sm font-bold text-slate-900" id="file-name-display">Fichier.pdf</p>
                                    <p class="text-[10px] text-brand-600 font-bold mt-1">Changer le fichier</p>
                                </div>
                            </div>

                        </div>
                    </div>
                    
                    <label class="flex items-start gap-3 p-3 bg-orange-50 border border-orange-100 rounded-xl cursor-pointer">
                        <input type="checkbox" id="reg-mandatory" class="w-5 h-5 text-orange-500 rounded mt-0.5">
                        <div><span class="text-sm font-bold text-orange-900 block">Heures Obligatoires</span><span class="text-[10px] text-orange-700">Pour validation stage/√©cole.</span></div>
                    </label>
                    <button type="submit" class="w-full py-4 bg-brand-600 text-white font-bold rounded-2xl shadow-lg mt-2">Cr√©er mon compte</button>
                </form>
            </div>
        </div>`;
            lucide.createIcons();
        }

        function handleFileSelect(input) {
            const zone = document.getElementById('upload-zone');
            const def = document.getElementById('upload-default');
            const suc = document.getElementById('upload-success');
            const name = document.getElementById('file-name-display');

            if (input.files && input.files[0]) {
                const file = input.files[0];

                // UX : Mise √† jour du design (Vert = Succ√®s)
                zone.classList.remove('border-slate-300', 'bg-slate-50');
                zone.classList.add('border-green-500', 'bg-green-50');

                def.classList.add('hidden');
                suc.classList.remove('hidden');
                suc.style.display = 'flex';

                // Affichage du nom (tronqu√© si trop long)
                name.innerText = file.name.length > 25 ? file.name.substring(0, 20) + '...' : file.name;

            } else {
                // Reset si annulation
                zone.classList.add('border-slate-300', 'bg-slate-50');
                zone.classList.remove('border-green-500', 'bg-green-50');

                def.classList.remove('hidden');
                suc.classList.add('hidden');
                suc.style.display = 'none';
            }
        }
        function toggleAuth(t) {
            const l = document.getElementById('form-login'), r = document.getElementById('form-register');
            const bl = document.getElementById('tab-login'), br = document.getElementById('tab-register');
            if (t === 'login') { l.classList.remove('hidden'); r.classList.add('hidden'); bl.className = "flex-1 py-3 rounded-lg text-sm font-bold bg-white text-brand-600 shadow-sm transition"; br.className = "flex-1 py-3 rounded-lg text-sm font-bold text-slate-400 hover:text-slate-600 transition"; }
            else { l.classList.add('hidden'); r.classList.remove('hidden'); br.className = "flex-1 py-3 rounded-lg text-sm font-bold bg-white text-brand-600 shadow-sm transition"; bl.className = "flex-1 py-3 rounded-lg text-sm font-bold text-slate-400 hover:text-slate-600 transition"; }
        }

        function renderAppShell() {
            const root = document.getElementById('root');

            // CORRECTION : 
            // 1. On change h-screen par h-full car le body a d√©j√† une hauteur d√©finie en CSS (100dvh)
            // 2. On change la nav mobile de 'absolute' √† 'fixed' pour qu'elle flotte par-dessus tout

            root.innerHTML = `
        <div class="flex h-full w-full overflow-hidden bg-[#F8FAFC]">

            <aside class="hidden md:flex w-72 flex-col bg-white border-r border-slate-100 z-50 flex-shrink-0">
                <div class="h-24 flex items-center px-8 flex-shrink-0">
                    <img src="${LOGO_URL}" class="h-10 w-auto mr-3">
                    <span class="font-extrabold text-2xl text-brand-900">COP1</span>
                </div>
                
                <nav id="sidebar-nav" class="flex-1 px-4 space-y-2 py-4 overflow-y-auto no-scrollbar"></nav>
                
                <div class="p-6 flex-shrink-0 border-t border-slate-50">
                    <button onclick="handleLogout()" class="flex items-center gap-3 text-sm font-bold text-red-500 hover:bg-red-50 w-full p-4 rounded-xl transition">
                        <i data-lucide="log-out" class="w-5 h-5"></i> D√©connexion
                    </button>
                </div>
            </aside>

            <div class="flex-1 flex flex-col h-full relative min-w-0">

                <header class="md:hidden glass absolute top-0 w-full h-16 z-40 flex items-center justify-between px-5 pt-safe border-b border-slate-200/50">
                    <div class="flex items-center gap-2">
                        <img src="${LOGO_URL}" class="h-8 w-auto">
                        <span class="font-extrabold text-xl text-brand-900">COP1</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <button onclick="toggleLanguage()" class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-xs">üåç</button>
                        <button onclick="setView('profile')" class="w-9 h-9 rounded-full bg-brand-100 text-brand-600 flex items-center justify-center font-bold text-sm border-2 border-white shadow-sm">
                            ${state.profile?.first_name?.[0] || '?'}
                        </button>
                    </div>
                </header>

                <main id="main-slot" class="flex-1 overflow-y-auto pt-20 pb-28 px-4 md:p-10 w-full scroll-smooth">
                </main>

                <nav id="mobile-nav" class="md:hidden glass fixed bottom-0 left-0 right-0 w-full pb-safe pt-2 px-2 flex justify-around items-center z-50 border-t border-slate-200/50 bg-white/90"></nav>
            </div>
        </div>
    `;
        }

        function renderSkeleton(view) {
            // Squelette pour les cartes (Events, P√¥les)
            const cardSkeleton = `
                <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 mb-4 animate-pulse">
                    <div class="flex gap-4 mb-4">
                        <div class="w-16 h-16 bg-slate-100 rounded-2xl flex-shrink-0"></div>
                        <div class="flex-1 space-y-2 py-2">
                            <div class="h-4 bg-slate-100 rounded w-3/4"></div>
                            <div class="h-3 bg-slate-100 rounded w-1/2"></div>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <div class="h-12 bg-slate-50 rounded-xl w-full"></div>
                        <div class="h-12 bg-slate-50 rounded-xl w-full"></div>
                    </div>
                </div>`;

            // Squelette pour l'annuaire (Admin Users)
            const listSkeleton = `
                <div class="flex justify-between items-center bg-white p-4 rounded-2xl border border-slate-100 mb-2 animate-pulse">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-full bg-slate-100"></div>
                        <div class="space-y-2">
                            <div class="h-3 bg-slate-100 rounded w-32"></div>
                            <div class="h-2 bg-slate-100 rounded w-20"></div>
                        </div>
                    </div>
                    <div class="w-8 h-8 bg-slate-100 rounded-lg"></div>
                </div>`;

            if (view === 'events' || view === 'admin_events' || view === 'poles') {
                return `<div class="pb-20 space-y-4">
                    <div class="flex justify-between items-center mb-6">
                        <div class="h-8 bg-slate-200 rounded-xl w-40 animate-pulse"></div>
                        <div class="h-10 w-10 bg-slate-200 rounded-full animate-pulse"></div>
                    </div>
                    ${cardSkeleton.repeat(3)}
                </div>`;
            } else if (view === 'admin_users' || view === 'messages') {
                return `<div class="pb-20 space-y-4">
                    <div class="h-8 bg-slate-200 rounded-xl w-40 mb-6 animate-pulse"></div>
                    ${listSkeleton.repeat(5)}
                </div>`;
            } else if (view === 'dashboard') {
                return `<div class="animate-pulse max-w-lg mx-auto pb-20 space-y-6">
                    <div class="h-8 bg-slate-200 rounded-xl w-1/2"></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="h-32 bg-slate-100 rounded-3xl"></div>
                        <div class="h-32 bg-slate-100 rounded-3xl"></div>
                    </div>
                    <div class="h-24 bg-slate-100 rounded-3xl"></div>
                </div>`;
            }

            // Fallback g√©n√©rique
            return `<div class="animate-pulse space-y-4 max-w-md mx-auto mt-10"><div class="h-8 bg-slate-200 rounded-xl w-1/2"></div><div class="h-32 bg-slate-200 rounded-2xl"></div><div class="h-32 bg-slate-200 rounded-2xl"></div></div>`;
        }

        async function setView(view) {
            localStorage.setItem('cop1_last_view', view);
            state.view = view;
            const main = document.getElementById('main-slot');
            if (!main) return;

            updateNavUI();
            window.scrollTo({ top: 0, behavior: 'smooth' }); // UX : Scroll doux

            if (['mentions', 'privacy', 'cgu'].includes(view)) {
                main.innerHTML = getLegalContent(view); lucide.createIcons(); return;
            }

            // UX : On affiche le Skeleton IMMEDIATEMENT avant de charger les donn√©es
            main.innerHTML = renderSkeleton(view);

            // Ensuite on charge les vraies donn√©es
            if (view === 'dashboard') await renderDashboard(main);
            else if (view === 'events') await renderEvents(main);
            else if (view === 'admin_users') await renderAnnuaire(main);
            else if (view === 'profile') renderProfile(main);
            else if (view === 'messages') await renderMessages(main);
            else if (view === 'poles') await renderPoles(main);
            else if (view === 'admin_events') await renderPlanningAdmin(main);

            lucide.createIcons();
        }

        function updateNavUI() {
            const isAdmin = state.profile.is_admin && state.adminMode;
            const sb = document.getElementById('sidebar-nav');
            const mb = document.getElementById('mobile-nav');

            // --- 1. CONFIGURATION DES MENUS ---

            // Menu complet pour l'ordinateur (Sidebar) - On garde TOUT
            const desktopItems = isAdmin ? [
                { id: 'dashboard', i: 'layout-grid', l: 'Accueil' },
                { id: 'admin_events', i: 'calendar-days', l: 'Planning' },
                { id: 'messages', i: 'message-circle', l: 'Chat' },
                { id: 'admin_users', i: 'users', l: 'Annuaire' },
                { id: 'poles', i: 'network', l: 'P√¥les' },
                { id: 'profile', i: 'user', l: 'Profil' }
            ] : [
                { id: 'events', i: 'calendar-check', l: 'Missions' },
                { id: 'poles', i: 'network', l: 'P√¥les' },
                { id: 'messages', i: 'message-circle', l: 'Chat' },
                { id: 'profile', i: 'user', l: 'Profil' }
            ];

            // Menu compact pour le mobile (Bottom Bar) - Limit√© √† 4
            let mobileItems = [];

            if (isAdmin) {
                // ADMIN MOBILE : Les 3 plus importants + un bouton "Menu"
                mobileItems = [
                    { id: 'dashboard', i: 'layout-grid', l: 'Accueil' },
                    { id: 'admin_events', i: 'calendar-days', l: 'Planning' },
                    { id: 'messages', i: 'message-circle', l: 'Chat' },
                    { id: 'MENU', i: 'menu', l: 'Menu' } // <--- Le bouton magique
                ];
            } else {
                // B√âN√âVOLE MOBILE : On garde les 4 classiques
                mobileItems = [
                    { id: 'events', i: 'calendar-check', l: 'Missions' },
                    { id: 'poles', i: 'network', l: 'P√¥les' },
                    { id: 'messages', i: 'message-circle', l: 'Chat' },
                    { id: 'profile', i: 'user', l: 'Profil' }
                ];
            }

            // --- 2. RENDU HTML ---

            // A. Sidebar Desktop (Inchang√©)
            if (sb) {
                sb.innerHTML = desktopItems.map(i => `
            <button onclick="setView('${i.id}')" class="w-full flex items-center gap-4 p-4 rounded-2xl font-bold text-sm transition ${state.view === i.id ? 'bg-brand-600 text-white shadow-lg' : 'text-slate-500 hover:bg-slate-50'}">
                <i data-lucide="${i.i}" class="w-5 h-5"></i> ${i.l}
            </button>
        `).join('') + (isAdmin ? `<div class="mt-8 px-4"><div class="text-xs font-bold text-slate-400 uppercase mb-2">Mode</div><button onclick="toggleAdminMode()" class="w-full py-3 bg-slate-100 rounded-xl text-xs font-bold text-slate-600 hover:bg-slate-200 transition">Vue B√©n√©vole</button></div>` : '');
            }

            // B. Mobile Bottom Bar (Optimis√©)
            if (mb) {
                mb.innerHTML = mobileItems.map(i => {
                    // Cas sp√©cial pour le bouton MENU
                    if (i.id === 'MENU') {
                        // On v√©rifie si on est sur une page "cach√©e" dans le menu pour allumer l'ic√¥ne
                        const isMenuPageActive = ['admin_users', 'poles', 'profile'].includes(state.view);
                        return `
                <button onclick="openMobileMenu()" class="flex flex-col items-center justify-center gap-1.5 py-3 w-1/4 transition ${isMenuPageActive ? 'text-brand-600' : 'text-slate-400'}">
                    <i data-lucide="menu" class="w-6 h-6 ${isMenuPageActive ? 'fill-brand-100' : ''}"></i>
                    <span class="text-[10px] font-bold">Menu</span>
                </button>`;
                    }

                    // Boutons normaux
                    const isActive = state.view === i.id;
                    return `
            <button onclick="setView('${i.id}')" class="flex flex-col items-center justify-center gap-1.5 py-3 w-1/4 transition ${isActive ? 'text-brand-600' : 'text-slate-400'}">
                <i data-lucide="${i.i}" class="w-6 h-6 ${isActive ? 'fill-brand-100' : ''}"></i>
                <span class="text-[10px] font-bold">${i.l}</span>
            </button>`;
                }).join('');
            }

            lucide.createIcons();
        }

        function openMobileMenu() {
            const m = document.createElement('div');
            m.id = 'mobile-menu-modal';
            m.className = 'fixed inset-0 bg-slate-900/40 z-[100] flex flex-col justify-end backdrop-blur-sm animate-fade-in md:hidden';

            // Fermeture si on clique sur le fond flou
            m.onclick = (e) => { if (e.target === m) m.remove(); };

            m.innerHTML = `
        <div class="bg-white rounded-t-[2rem] p-6 pb-safe shadow-2xl animate-slide-up">
            <div class="flex justify-center mb-6">
                <div class="w-12 h-1.5 bg-slate-200 rounded-full"></div>
            </div>
            
            <h3 class="text-lg font-extrabold text-slate-900 mb-6 px-2">Menu Administrateur</h3>
            
            <div class="grid grid-cols-2 gap-4 mb-6">
                <button onclick="document.getElementById('mobile-menu-modal').remove(); setView('admin_users')" class="flex flex-col items-center justify-center p-4 bg-slate-50 rounded-2xl border border-slate-100 active:scale-95 transition">
                    <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center text-brand-600 shadow-sm mb-3">
                        <i data-lucide="users" class="w-6 h-6"></i>
                    </div>
                    <span class="font-bold text-slate-700 text-sm">Annuaire</span>
                </button>

                <button onclick="document.getElementById('mobile-menu-modal').remove(); setView('poles')" class="flex flex-col items-center justify-center p-4 bg-slate-50 rounded-2xl border border-slate-100 active:scale-95 transition">
                    <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center text-purple-600 shadow-sm mb-3">
                        <i data-lucide="network" class="w-6 h-6"></i>
                    </div>
                    <span class="font-bold text-slate-700 text-sm">P√¥les</span>
                </button>

                <button onclick="document.getElementById('mobile-menu-modal').remove(); setView('profile')" class="flex flex-col items-center justify-center p-4 bg-slate-50 rounded-2xl border border-slate-100 active:scale-95 transition">
                    <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center text-slate-600 shadow-sm mb-3">
                        <i data-lucide="user" class="w-6 h-6"></i>
                    </div>
                    <span class="font-bold text-slate-700 text-sm">Mon Profil</span>
                </button>

                <button onclick="document.getElementById('mobile-menu-modal').remove(); toggleAdminMode()" class="flex flex-col items-center justify-center p-4 bg-slate-900 text-white rounded-2xl shadow-lg active:scale-95 transition">
                    <div class="w-12 h-12 bg-white/10 rounded-full flex items-center justify-center text-white mb-3">
                        <i data-lucide="arrow-left-right" class="w-6 h-6"></i>
                    </div>
                    <span class="font-bold text-xs">Vue B√©n√©vole</span>
                </button>
            </div>

            <button onclick="document.getElementById('mobile-menu-modal').remove()" class="w-full py-4 bg-slate-100 font-bold text-slate-500 rounded-2xl">Fermer</button>
        </div>
    `;

            document.body.appendChild(m);
            lucide.createIcons();
        }
        function toggleAdminMode() {
            // On inverse l'√©tat actuel
            state.adminMode = !state.adminMode;

            // 1. SAUVEGARDE : On stocke le choix dans le navigateur
            // Si adminMode est true, on sauvegarde 'true', sinon 'false'
            localStorage.setItem('cop1_admin_mode', state.adminMode);

            // 2. REDIRECTION : On change la vue imm√©diatement
            // Si on passe en mode Admin -> Dashboard
            // Si on repasse en mode B√©n√©vole -> Events (Missions)
            setView(state.adminMode ? 'dashboard' : 'events');
        }
        // ============================================================
        // 5. FEATURE RENDERERS
        // ============================================================

        // --- DASHBOARD ---
        async function renderDashboard(c) {
            // 1. Stats g√©n√©rales
            const { data: stats } = await supabase.from('profiles').select('total_hours, status');
            const totalHours = stats.reduce((acc, curr) => acc + (curr.total_hours || 0), 0);
            const pending = stats.filter(u => u.status === 'pending').length;

            // Config graphique cercle
            const radius = 35, circumference = 2 * Math.PI * radius, progress = Math.min(100, (pending / 20) * 100), offset = circumference - (progress / 100) * circumference;

            // 2. Logique "Urgences" (J+7)
            const today = new Date();
            const nextWeek = new Date();
            nextWeek.setDate(today.getDate() + 7);

            const { data: events } = await supabase
                .from('events')
                .select('*, shifts(*, registrations(count))')
                .gte('date', today.toISOString())
                .lte('date', nextWeek.toISOString())
                .order('date');

            let urgentHtml = '';
            let urgentCount = 0;

            if (events) {
                events.forEach(e => {
                    e.shifts.forEach(s => {
                        // CORRECTION : V√©rification s√©curis√©e du tableau registrations
                        const taken = (s.registrations && s.registrations.length > 0) ? s.registrations[0].count : 0;
                        const remaining = s.max_slots - taken;

                        // Si il reste des places
                        if (remaining > 0) {
                            urgentCount++;
                            urgentHtml += `
                        <div class="flex justify-between items-center p-3 bg-red-50 rounded-2xl border border-red-100 mb-2">
                            <div>
                                <div class="font-bold text-slate-800 text-sm">${e.title}</div>
                                <div class="text-xs text-red-500 font-bold flex items-center gap-1">
                                    <i data-lucide="alert-circle" class="w-3 h-3"></i> Manque ${remaining} pers. ‚Ä¢ ${new Date(e.date).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' })}
                                </div>
                                <div class="text-xs text-slate-500 mt-0.5">${s.title} (${s.start_time.slice(0, 5)})</div>
                            </div>
                            <button onclick="setView('admin_events')" class="px-3 py-2 bg-white text-red-600 text-xs font-bold border border-red-200 rounded-xl shadow-sm hover:bg-red-100 transition">
                                G√©rer
                            </button>
                        </div>
                    `;
                        }
                    });
                });
            }

            if (urgentCount === 0) {
                urgentHtml = '<div class="p-4 text-center text-slate-400 text-sm bg-green-50 rounded-2xl border border-green-100"><i data-lucide="check-circle" class="w-5 h-5 mx-auto mb-1 text-green-500"></i>Aucune urgence planning !</div>';
            }

            // 3. Rendu HTML
            c.innerHTML = `
        <div class="animate-fade-in max-w-lg mx-auto pb-20">
            <h2 class="text-2xl font-extrabold text-slate-900 mb-6">Tableau de bord</h2>
            
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 relative overflow-hidden group">
                    <div class="relative z-10"><div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">B√©n√©voles</div><div class="text-4xl font-extrabold text-slate-900">${stats.filter(u => u.status === 'approved').length}</div></div>
                    <div class="absolute -right-4 -bottom-4 bg-brand-50 w-24 h-24 rounded-full group-hover:scale-125 transition duration-500"></div>
                </div>
                <div class="bg-brand-600 p-5 rounded-3xl shadow-lg shadow-brand-200 text-white relative overflow-hidden">
                    <div class="relative z-10"><div class="text-xs font-bold text-brand-200 uppercase tracking-wider mb-1">Heures</div><div class="text-4xl font-extrabold">${Math.round(totalHours)}h</div></div>
                    <i data-lucide="clock" class="absolute -right-2 -bottom-2 w-20 h-20 text-white opacity-20 rotate-12"></i>
                </div>
            </div>

            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 flex items-center justify-between mb-6">
                <div><h3 class="font-bold text-lg text-slate-900 mb-1">Validations</h3><p class="text-slate-500 text-sm">Inscriptions √† traiter.</p><button onclick="setView('admin_users')" class="mt-4 px-5 py-2.5 bg-slate-900 text-white text-xs font-bold rounded-xl hover:bg-slate-700 transition">G√©rer</button></div>
                <div class="relative w-24 h-24 flex items-center justify-center"><svg class="w-full h-full transform -rotate-90"><circle cx="48" cy="48" r="${radius}" stroke="#f1f5f9" stroke-width="8" fill="transparent"/><circle cx="48" cy="48" r="${radius}" stroke="#3b82f6" stroke-width="8" fill="transparent" stroke-dasharray="${circumference}" stroke-dashoffset="${offset}" stroke-linecap="round"/></svg><span class="absolute text-xl font-bold text-slate-900">${pending}</span></div>
            </div>

            <div class="bg-white rounded-3xl p-5 shadow-sm border border-slate-100 mb-6">
                <h3 class="font-bold text-slate-800 flex items-center gap-2 mb-4">
                    <i data-lucide="siren" class="w-5 h-5 text-red-500"></i> Urgences (7 jours)
                </h3>
                <div class="space-y-2">
                    ${urgentHtml}
                </div>
            </div>

            <button onclick="openCreateEventModal()" class="w-full py-4 rounded-3xl border-2 border-dashed border-slate-300 text-slate-400 font-bold hover:border-brand-500 hover:text-brand-500 transition flex items-center justify-center gap-2"><i data-lucide="plus-circle" class="w-5 h-5"></i> Cr√©er √©v√©nement</button>
        </div>`;
        }

        // --- EVENTS (USER) ---
        async function renderEvents(c) {
            const today = new Date().toISOString().split('T')[0];
            const { data: events } = await supabase.from('events').select('*, shifts(*, registrations(*))').gte('date', today).order('date');
            const { data: myRegs } = await supabase.from('registrations').select('shift_id').eq('user_id', state.user?.id);

            const safeEvents = Array.isArray(events) ? events : [];
            const safeMyRegs = Array.isArray(myRegs) ? myRegs : [];
            const myIds = safeMyRegs.map(r => r.shift_id);

            // --- UX : EMPTY STATE AM√âLIOR√â ---
            const emptyState = `
        <div class="flex flex-col items-center justify-center py-16 text-center animate-fade-in">
            <div class="w-24 h-24 bg-slate-50 rounded-full flex items-center justify-center mb-4">
                <i data-lucide="coffee" class="w-10 h-10 text-slate-300"></i>
            </div>
            <h3 class="text-lg font-bold text-slate-900">C'est calme par ici...</h3>
            <p class="text-sm text-slate-500 max-w-xs mt-2">Aucune mission n'est pr√©vue pour le moment. Revenez un peu plus tard !</p>
        </div>
    `;

            c.innerHTML = `
        <div class="flex items-center justify-between mb-6"><h2 class="text-2xl font-extrabold text-slate-900">Missions</h2><button onclick="openScanner()" class="bg-brand-600 text-white w-14 h-14 rounded-full flex items-center justify-center shadow-xl shadow-brand-200 hover:bg-brand-700 active:scale-95 transition"><i data-lucide="scan-line" class="w-7 h-7"></i></button>
        </div>
        ${safeEvents.map(e => {
                const date = new Date(e.date);
                const safeTitle = escapeHtml(e.title);
                const safeLoc = escapeHtml(e.location || '');

                const shifts = Array.isArray(e.shifts) ? e.shifts : [];
                return `
            <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 mb-4 animate-fade-in">
                <div class="flex gap-4 mb-4">
                    <div class="flex flex-col items-center justify-center bg-brand-50 text-brand-700 w-16 h-16 rounded-2xl flex-shrink-0"><span class="text-xs font-bold uppercase">${date.toLocaleDateString('fr', { month: 'short' })}</span><span class="text-2xl font-extrabold leading-none">${date.getDate()}</span></div>
                    <div><h3 class="font-bold text-lg text-slate-900 leading-tight">${safeTitle}</h3><div class="text-sm text-slate-500 flex items-center gap-1 mt-1"><i data-lucide="map-pin" class="w-3 h-3"></i> ${safeLoc}</div></div>
                </div>
                <div class="space-y-2">
                    ${shifts.map(s => {
                    const safeShiftTitle = escapeHtml(s.title);
                    const regs = Array.isArray(s.registrations) ? s.registrations : [];
                    const taken = regs.length ? (regs[0].count || regs.length) : 0;
                    const left = (s.max_slots || 0) - taken;
                    const isReg = myIds.includes(s.id);
                    const width = s.max_slots ? Math.max(0, Math.min(100, (taken / s.max_slots) * 100)) : 0;
                    return `<div class="border border-slate-100 rounded-2xl p-3 ${isReg ? 'bg-green-50 border-green-200' : 'bg-slate-50'}"><div class="flex justify-between items-center mb-2"><span class="font-bold text-sm text-slate-700">${safeShiftTitle} <span class="font-normal text-slate-400 text-xs ml-1">${(s.start_time || '').slice(0, 5)}-${(s.end_time || '').slice(0, 5)}</span></span>${isReg ? '<span class="text-xs font-bold text-green-600 bg-white px-2 py-1 rounded-lg shadow-sm">Inscrit</span>' : ''}</div><div class="flex items-center gap-3"><div class="flex-1 h-2 bg-slate-200 rounded-full overflow-hidden"><div class="h-full bg-brand-500 rounded-full" style="width:${width}%"></div></div><div class="text-xs font-bold text-slate-500 whitespace-nowrap">${left} places</div></div>${!isReg && left > 0 ? `<button onclick="toggleReg(${s.id})" class="mt-3 w-full py-2 bg-white border border-slate-200 rounded-xl text-xs font-bold text-brand-600 hover:bg-brand-50 transition">S'inscrire</button>` : ''}${isReg ? `<button onclick="toggleReg(${s.id},true)" class="mt-3 w-full py-2 text-red-500 text-xs font-bold hover:bg-red-50 rounded-xl transition">Se d√©sister</button>` : ''}</div>`;
                }).join('')}
                </div>
            </div>`;
            }).join('') || emptyState}
    `;
        }

        async function toggleReg(id, rm = false) {
            // --- D√âSINSCRIPTION ---
            if (rm) {
                if (!confirm("Se d√©sinscrire de ce cr√©neau ?")) return;
                toggleLoader(true);
                // La RLS permet maintenant de supprimer SA propre inscription en toute s√©curit√©
                const { error } = await supabase.from('registrations').delete().eq('user_id', state.user.id).eq('shift_id', id);

                if (error) {
                    console.error(error);
                    showToast("Erreur lors de la d√©sinscription", "error");
                } else {
                    showToast('D√©sinscription valid√©e');
                    if (state.view === 'events') await renderEvents(document.getElementById('main-slot'));
                }
                toggleLoader(false);
                return;
            }

            // --- INSCRIPTION (Via RPC SQL pour √©viter les conflits) ---
            toggleLoader(true);

            try {
                // 1. R√©cup√©ration info pour warning "Quota Scolaire" (Optionnel, informatif)
                // On le fait avant pour avertir l'utilisateur, mais la vraie s√©curit√© est dans le RPC
                const { data: shift } = await supabase.from('shifts')
                    .select('reserved_slots, registrations(profiles(mandatory_hours))')
                    .eq('id', id)
                    .single();

                if (shift) {
                    const schoolCount = shift.registrations.filter(r => r.profiles && r.profiles.mandatory_hours).length;
                    const amISchool = state.profile.mandatory_hours;

                    // Logique Avertissement Quota
                    if (amISchool && schoolCount >= shift.reserved_slots) {
                        if (!confirm("‚ö†Ô∏è AVERTISSEMENT QUOTA\n\nLes places r√©serv√©es 'Scolaire' sont prises.\nCes heures ne compteront PAS pour votre stage.\n\nContinuer ?")) {
                            toggleLoader(false);
                            return;
                        }
                    }
                }

                // 2. Appel de la fonction SQL s√©curis√©e
                const { error } = await supabase.rpc('register_to_shift', {
                    p_user_id: state.user.id,
                    p_shift_id: id
                });

                if (error) throw error;

                showToast('Inscription r√©ussie !');
                if (state.view === 'events') await renderEvents(document.getElementById('main-slot'));

            } catch (err) {
                console.error(err);
                // Le message d'erreur SQL (ex: "Complet") sera affich√© ici
                showToast(err.message || "Erreur inscription", "error");
            } finally {
                toggleLoader(false);
            }
        }

        // ============================================================
        // FONCTION renderProfile - DESIGN CLEAN & UNIFI√â
        // ============================================================

        function renderProfile(c) {
            const p = state.profile;
            const isMandatory = p.mandatory_hours;

            c.innerHTML = `
        <div class="animate-slide-up max-w-lg mx-auto pb-24 space-y-5">
            
            <div class="bg-white rounded-[2rem] shadow-sm border border-slate-100 p-6 text-center relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-20 bg-gradient-to-b from-brand-50 to-white"></div>
                
                <div class="relative z-10">
                    <div class="relative w-24 h-24 mx-auto mb-3">
                        <div class="w-full h-full bg-white text-brand-600 rounded-full flex items-center justify-center text-3xl font-extrabold shadow-lg border-4 border-white">
                            ${p.first_name[0]}
                        </div>
                        ${p.is_admin ? '<div class="absolute bottom-0 right-0 bg-yellow-400 text-yellow-900 p-1.5 rounded-full border-4 border-white shadow-sm"><i data-lucide="shield" class="w-4 h-4"></i></div>' : ''}
                    </div>

                    <h2 class="text-xl font-extrabold text-slate-900">${p.first_name} ${p.last_name}</h2>
                    <p class="text-slate-400 font-medium text-sm mb-5">${state.user.email}</p>

                    <div class="flex justify-center gap-3">
                        <div class="px-4 py-2 bg-slate-50 rounded-xl border border-slate-100">
                            <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wide">Statut</div>
                            <div class="font-bold text-brand-600 text-sm">${isMandatory ? 'Scolaire' : 'B√©n√©vole'}</div>
                        </div>
                        <div class="px-4 py-2 bg-slate-50 rounded-xl border border-slate-100">
                            <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wide">Permis</div>
                            <div class="font-bold ${p.has_permit ? 'text-green-600' : 'text-slate-400'} text-sm">${p.has_permit ? 'Oui' : 'Non'}</div>
                        </div>
                    </div>
                </div>
            </div>

            ${isMandatory ? `
            <div class="bg-gradient-to-br from-emerald-500 to-teal-600 rounded-[2rem] p-6 text-white shadow-lg shadow-emerald-200 relative overflow-hidden flex items-center justify-between">
                <div class="relative z-10">
                    <p class="text-emerald-100 text-xs font-bold uppercase tracking-wider mb-1">Compteur Heures</p>
                    <p class="text-5xl font-extrabold tracking-tighter">${p.total_hours || 0}<span class="text-2xl opacity-60 ml-1">h</span></p>
                </div>
                <i data-lucide="award" class="w-24 h-24 text-white opacity-20 absolute -right-4 -bottom-4 rotate-12"></i>
            </div>
            ` : ''}

            <div class="bg-white rounded-[2rem] shadow-sm border border-slate-100 overflow-hidden divide-y divide-slate-50">
                
                ${p.is_admin ? `
                <button onclick="toggleAdminMode()" class="w-full flex items-center justify-between p-5 hover:bg-slate-50 transition group bg-slate-50/50">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 bg-slate-200 text-slate-700 rounded-xl flex items-center justify-center group-hover:scale-110 transition">
                            <i data-lucide="arrow-left-right" class="w-5 h-5"></i>
                        </div>
                        <span class="font-bold text-slate-700 text-sm">Passer en ${state.adminMode ? 'Vue B√©n√©vole' : 'Vue Responsable'}</span>
                    </div>
                    <i data-lucide="chevron-right" class="w-5 h-5 text-slate-300"></i>
                </button>` : ''}

                <button onclick="viewUserHistory('${state.user.id}')" class="w-full flex items-center justify-between p-5 hover:bg-slate-50 transition group">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 bg-blue-50 text-blue-600 rounded-xl flex items-center justify-center group-hover:scale-110 transition">
                            <i data-lucide="history" class="w-5 h-5"></i>
                        </div>
                        <span class="font-bold text-slate-700 text-sm">Historique complet</span>
                    </div>
                    <i data-lucide="chevron-right" class="w-5 h-5 text-slate-300"></i>
                </button>

                <button onclick="openEditProfileModal()" class="w-full flex items-center justify-between p-5 hover:bg-slate-50 transition group">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 bg-purple-50 text-purple-600 rounded-xl flex items-center justify-center group-hover:scale-110 transition">
                            <i data-lucide="settings" class="w-5 h-5"></i>
                        </div>
                        <span class="font-bold text-slate-700 text-sm">Modifier mes infos</span>
                    </div>
                    <i data-lucide="chevron-right" class="w-5 h-5 text-slate-300"></i>
                </button>

                <button onclick="handleLogout()" class="w-full flex items-center justify-between p-5 hover:bg-red-50 transition group">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 bg-red-50 text-red-500 rounded-xl flex items-center justify-center group-hover:scale-110 transition">
                            <i data-lucide="log-out" class="w-5 h-5"></i>
                        </div>
                        <span class="font-bold text-red-500 text-sm">Me d√©connecter</span>
                    </div>
                </button>
            </div>

            <div class="pt-6 border-t border-slate-200/50">
                <button onclick="openDeleteAccountModal()" class="w-full py-4 rounded-2xl border border-red-100 text-red-400 text-xs font-bold hover:bg-red-50 hover:text-red-600 transition flex items-center justify-center gap-2 group">
                    <i data-lucide="trash-2" class="w-4 h-4 group-hover:scale-110 transition"></i>
                    Supprimer mon compte d√©finitivement
                </button>
                <p class="text-center text-[10px] text-slate-300 mt-2">Cette action est irr√©versible.</p>
            </div>

            <div class="text-center text-xs text-slate-300 font-medium pt-2 pb-6">
                Version 1.0 ‚Ä¢ COP1 Angers
            </div>
        </div>
    `;
            lucide.createIcons();
        }

        // --- ADMIN USERS ---
        let adminSearch = '';
        let adminFilter = 'all'; // all, pending, permit, mandatory
        let adminPage = 0;       // NOUVEAU : Page actuelle (0 = page 1)
        const ITEMS_PER_PAGE = 20;

        async function renderAnnuaire(c) {
            // 1. Loader discret (squelette) si c'est le premier chargement
            if (!state.allUsers || state.allUsers.length === 0) c.innerHTML = renderSkeleton('admin_users');

            // 2. Construction de la requ√™te SERVER-SIDE
            // On demande aussi le 'count' (nombre total) pour g√©rer la pagination
            let query = supabase
                .from('profiles')
                .select('*', { count: 'exact' });

            // 3. Application des Filtres SQL
            if (adminSearch) {
                // Recherche insensible √† la casse dans Pr√©nom OU Nom
                query = query.or(`first_name.ilike.%${adminSearch}%,last_name.ilike.%${adminSearch}%`);
            }

            if (adminFilter === 'pending') query = query.eq('status', 'pending');
            else if (adminFilter === 'permit') query = query.eq('has_permit', true);
            else if (adminFilter === 'mandatory') query = query.eq('mandatory_hours', true);

            // 4. Application de la Pagination
            const from = adminPage * ITEMS_PER_PAGE;
            const to = from + ITEMS_PER_PAGE - 1;

            query = query
                .order('created_at', { ascending: false })
                .range(from, to);

            // 5. Ex√©cution
            const { data, count, error } = await query;

            if (error) {
                console.error(error);
                return showToast("Erreur chargement annuaire", "error");
            }

            // 6. Rendu HTML
            const totalPages = Math.ceil((count || 0) / ITEMS_PER_PAGE);
            const hasNext = adminPage < totalPages - 1;
            const hasPrev = adminPage > 0;

            c.innerHTML = `
        <div class="flex flex-col gap-4 mb-6 animate-fade-in">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-extrabold text-slate-900">B√©n√©voles</h2>
                <span class="bg-slate-100 text-slate-500 px-3 py-1 rounded-full text-xs font-bold">${count} trouv√©s</span>
            </div>

            <div class="relative">
                <i data-lucide="search" class="absolute left-4 top-3.5 w-5 h-5 text-slate-400"></i>
                <input oninput="handleSearchInput(this.value)" value="${adminSearch}" type="text" placeholder="Rechercher..." class="w-full pl-12 pr-4 py-3 bg-white rounded-xl shadow-sm border border-slate-100 outline-none font-bold text-sm focus:ring-2 focus:ring-brand-500 transition">
            </div>

            <div class="flex gap-2 overflow-x-auto no-scrollbar pb-2">
                ${renderFilterChip('all', 'Tous')}
                ${renderFilterChip('pending', 'Validations')}
                ${renderFilterChip('permit', 'Permis B')}
                ${renderFilterChip('mandatory', 'Scolaires')}
            </div>
        </div>

        <div class="space-y-3 pb-8 min-h-[50vh]">
            ${data.length > 0 ? data.map(u => renderUserCard(u)).join('') : `<div class="text-center py-20 text-slate-400 font-medium">Aucun r√©sultat üïµÔ∏è‚Äç‚ôÇÔ∏è</div>`}
        </div>

        ${totalPages > 1 ? `
        <div class="flex items-center justify-between pt-4 border-t border-slate-200 pb-20">
            <button onclick="changePage(-1)" ${!hasPrev ? 'disabled' : ''} class="px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-2 transition ${!hasPrev ? 'text-slate-300 cursor-not-allowed' : 'text-slate-700 hover:bg-white hover:shadow-sm'}">
                <i data-lucide="arrow-left" class="w-4 h-4"></i> Pr√©c√©dent
            </button>
            <span class="text-xs font-bold text-slate-400">Page ${adminPage + 1} / ${totalPages}</span>
            <button onclick="changePage(1)" ${!hasNext ? 'disabled' : ''} class="px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-2 transition ${!hasNext ? 'text-slate-300 cursor-not-allowed' : 'text-slate-700 hover:bg-white hover:shadow-sm'}">
                Suivant <i data-lucide="arrow-right" class="w-4 h-4"></i>
            </button>
        </div>` : ''}
    `;

            // Mise √† jour de l'√©tat global pour les autres fonctions (d√©tails, etc.)
            state.allUsers = data;
            lucide.createIcons();
        }

        // Change la page et recharge
        function changePage(delta) {
            adminPage += delta;
            renderAnnuaire(document.getElementById('main-slot'));
            // Petit scroll vers le haut de la liste
            document.getElementById('main-slot').scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Reset la pagination quand on change de filtre
        function setAdminFilter(val) {
            adminFilter = val;
            adminPage = 0; // Retour page 1
            renderAnnuaire(document.getElementById('main-slot'));
        }

        // Anti-spam pour la recherche (attend 500ms avant de lancer la requ√™te)
        let searchTimer;
        function handleSearchInput(val) {
            clearTimeout(searchTimer);
            searchTimer = setTimeout(() => {
                adminSearch = val;
                adminPage = 0; // Retour page 1
                renderAnnuaire(document.getElementById('main-slot'));
            }, 500);
        }
        // Note : Supprime l'ancienne fonction 'updateAdminSearch' si elle existe encore

        function renderFilterChip(key, label) {
            const active = adminFilter === key;
            return `<button onclick="setAdminFilter('${key}')" class="whitespace-nowrap px-4 py-2 rounded-xl text-xs font-bold transition ${active ? 'bg-slate-900 text-white shadow-lg' : 'bg-white text-slate-500 border border-slate-100'}">${label}</button>`;
        }


        function renderUserCard(u) {
            const isPending = u.status === 'pending';
            const firstNameSafe = escapeHtml(u.first_name || '');
            const lastNameSafe = escapeHtml(u.last_name || '');
            const initial = firstNameSafe.charAt(0) || '?';

            // On pr√©pare le nom complet pour la fonction de contact
            const fullName = `${firstNameSafe} ${lastNameSafe}`.replace(/'/g, "\\'"); // √âchappement des apostrophes pour le JS

            return `
        <div class="bg-white p-4 rounded-2xl border border-slate-100 flex items-center justify-between animate-fade-in hover:shadow-md transition">
            <div class="flex items-center gap-3 cursor-pointer" onclick="viewUserDetails('${u.id}')">
                <div class="relative">
                    <div class="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center font-bold text-slate-500 text-lg uppercase">${initial}</div>
                    ${u.is_admin ? '<div class="absolute -bottom-1 -right-1 bg-yellow-400 text-yellow-900 rounded-full p-0.5 border-2 border-white"><i data-lucide="shield" class="w-3 h-3"></i></div>' : ''}
                </div>
                <div>
                    <div class="font-bold text-slate-900 flex items-center gap-1">
                        ${firstNameSafe} ${lastNameSafe}
                    </div>
                    <div class="text-xs text-slate-400 flex gap-2">
                        ${u.has_permit ? '<span class="text-green-600 font-bold">üöó Permis</span>' : ''}
                        ${u.mandatory_hours ? '<span class="text-orange-500 font-bold">üéì Scolaire</span>' : 'B√©n√©vole'}
                    </div>
                </div>
            </div>
            
            ${isPending ? `
                <div class="flex gap-2">
                    <button onclick="openProof('${u.id}')" class="bg-blue-50 text-blue-600 p-2.5 rounded-xl hover:bg-blue-100 transition" title="Voir justificatif">
                        <i data-lucide="eye" class="w-5 h-5"></i>
                    </button>
                    <button onclick="validate('${u.id}', true)" class="bg-green-100 text-green-700 p-2.5 rounded-xl hover:bg-green-200 transition" title="Valider">
                        <i data-lucide="check" class="w-5 h-5"></i>
                    </button>
                    <button onclick="validate('${u.id}', false)" class="bg-red-50 text-red-500 p-2.5 rounded-xl hover:bg-red-100 transition" title="Refuser">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
            ` : `
                <div class="flex gap-2">
                    <button onclick="contactVolunteer('${u.id}', '${fullName}')" class="bg-brand-50 text-brand-600 p-2.5 rounded-xl hover:bg-brand-100 transition border border-brand-100" title="Envoyer un message">
                        <i data-lucide="message-circle" class="w-5 h-5"></i>
                    </button>
                    
                    <button onclick="viewUserDetails('${u.id}')" class="bg-slate-50 p-2.5 rounded-xl text-slate-400 hover:text-slate-600 hover:bg-slate-100 transition">
                        <i data-lucide="more-horizontal" class="w-5 h-5"></i>
                    </button>
                </div>
            `}
        </div>
    `;
        }

        // --- PLANNING ADMIN (MODALES & LOGIC) ---
        async function renderPlanningAdmin(c) {
            if (state.admins.length === 0) await loadAdmins();

            // Initialiser l'√©tat si pas d√©fini
            if (!state.planningTab) state.planningTab = 'upcoming';

            const today = new Date().toISOString().split('T')[0];

            let query = supabase
                .from('events')
                .select('*, shifts(*, registrations(count))')
                .order('date', { ascending: state.planningTab === 'upcoming' }); // Ascendant pour futur, Descendant pour pass√© serait mieux mais gardons simple

            if (state.planningTab === 'upcoming') {
                query = query.gte('date', today);
            } else {
                query = query.lt('date', today); // Historique
            }

            const { data: events } = await query;

            // UI Onglets
            const tabClass = "flex-1 py-2 text-sm font-bold rounded-xl transition";
            const activeTab = "bg-slate-900 text-white shadow-md";
            const inactiveTab = "text-slate-500 hover:bg-slate-100";

            c.innerHTML = `
        <div class="flex justify-between items-end mb-6">
            <div>
                <h2 class="text-2xl font-extrabold text-slate-900">Planning</h2>
                <p class="text-slate-500 text-sm">G√©rez les missions et les cr√©neaux.</p>
            </div>
            <button onclick="openCreateEventModal()" class="bg-brand-600 text-white px-4 py-3 rounded-xl text-sm font-bold shadow-lg shadow-brand-200 hover:bg-brand-700 transition flex items-center gap-2">
                <i data-lucide="plus-circle" class="w-4 h-4"></i> Nouveau
            </button>
        </div>

        <div class="bg-white p-1 rounded-2xl border border-slate-100 flex mb-6">
            <button onclick="setPlanningTab('upcoming')" class="${tabClass} ${state.planningTab === 'upcoming' ? activeTab : inactiveTab}">√Ä venir</button>
            <button onclick="setPlanningTab('history')" class="${tabClass} ${state.planningTab === 'history' ? activeTab : inactiveTab}">Historique</button>
        </div>

        <div class="space-y-6 pb-24">
            ${events && events.length ? events.map(e => renderEventCard(e)).join('') : '<div class="text-center py-20 text-slate-400">Aucun √©v√©nement dans cette vue.</div>'}
        </div>
    `;

            renderCreateEventModal(document.body);
            lucide.createIcons();
        }

        function setPlanningTab(t) {
            state.planningTab = t;
            renderPlanningAdmin(document.getElementById('main-slot'));
        }

        // Fonction de suppression d'un seul cr√©neau
        async function deleteSingleShift(id) {
            if (!confirm("Supprimer ce cr√©neau ? Les b√©n√©voles inscrits seront d√©sinscrits.")) return;
            toggleLoader(true);

            try {
                // 1. On supprime d'abord les inscriptions li√©es
                await supabase.from('registrations').delete().eq('shift_id', id);

                // 2. Ensuite on supprime le cr√©neau
                const { error } = await supabase.from('shifts').delete().eq('id', id);

                if (error) throw error;

                showToast('Cr√©neau supprim√©');

                // Rafra√Æchir l'affichage
                renderPlanningAdmin(document.getElementById('main-slot'));

            } catch (err) {
                console.error(err);
                showToast("Erreur suppression : " + err.message, "error");
            } finally {
                toggleLoader(false);
            }
        }

        // Modale d'√©dition d'un cr√©neau
        function openEditShift(id, title, start, end, max) {
            const m = document.createElement('div');
            m.className = 'fixed inset-0 bg-black/60 z-[70] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in';
            m.innerHTML = `
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-slide-up">
            <h3 class="font-bold text-lg mb-4 text-slate-900">Modifier le Cr√©neau</h3>
            <form onsubmit="handleEditShift(event, '${id}')" class="space-y-3">
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Titre</label>
                    <input name="title" value="${title}" class="w-full p-3 bg-slate-50 rounded-xl font-bold border outline-none">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase ml-1">D√©but</label>
                        <input name="start" type="time" value="${start}" class="w-full p-3 bg-slate-50 rounded-xl font-bold border outline-none">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase ml-1">Fin</label>
                        <input name="end" type="time" value="${end}" class="w-full p-3 bg-slate-50 rounded-xl font-bold border outline-none">
                    </div>
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Places Max</label>
                    <input name="max" type="number" value="${max}" class="w-full p-3 bg-slate-50 rounded-xl font-bold border outline-none">
                </div>
                <button type="submit" class="w-full py-3 bg-brand-600 text-white font-bold rounded-xl shadow-lg mt-2">Enregistrer</button>
            </form>
            <button onclick="this.closest('.fixed').remove()" class="w-full py-3 mt-2 text-slate-400 font-bold text-sm">Annuler</button>
        </div>
    `;
            document.body.appendChild(m);
        }

        async function handleEditShift(e, id) {
            e.preventDefault();
            const fd = new FormData(e.target);
            toggleLoader(true);

            // Calcul des heures (si tu utilises hours_value en base)
            const d1 = new Date(`1970-01-01T${fd.get('start')}:00`), d2 = new Date(`1970-01-01T${fd.get('end')}:00`);
            const hours_value = parseFloat((Math.abs(d2 - d1) / 36e5).toFixed(1));

            await supabase.from('shifts').update({
                title: fd.get('title'),
                start_time: fd.get('start'),
                end_time: fd.get('end'),
                max_slots: parseInt(fd.get('max')),
                hours_value: hours_value
            }).eq('id', id);

            document.querySelector('.fixed.z-\\[70\\]').remove();
            showToast('Cr√©neau mis √† jour');
            renderPlanningAdmin(document.getElementById('main-slot'));
            toggleLoader(false);
        }

        function renderEventCard(e) {
            const date = new Date(e.date).toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });
            const safeTitle = escapeHtml(e.title);
            const safeLoc = escapeHtml(e.location);
            const safeDateVal = e.date;

            return `
        <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100 animate-fade-in group mb-6">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <div class="text-xs font-bold text-brand-600 uppercase tracking-wider mb-1">${date}</div>
                    <h3 class="text-xl font-extrabold text-slate-900">${safeTitle}</h3>
                    <div class="flex items-center gap-2 text-slate-500 text-sm mt-1">
                        <i data-lucide="map-pin" class="w-3 h-3"></i> ${safeLoc}
                    </div>
                </div>
                
                ${state.planningTab === 'upcoming' ? `
                <div class="flex gap-1">
                    <button onclick="openEditEventModal(${e.id}, '${safeTitle.replace(/'/g, "\\'")}', '${safeDateVal}', '${safeLoc.replace(/'/g, "\\'")}')" class="text-slate-300 hover:text-brand-600 p-2 hover:bg-brand-50 rounded-xl transition">
                        <i data-lucide="pencil" class="w-5 h-5"></i>
                    </button>
                    <button onclick="deleteEvent(${e.id})" class="text-slate-300 hover:text-red-500 p-2 hover:bg-red-50 rounded-xl transition">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                </div>` : ''}
            </div>

            <div class="space-y-3">
                ${e.shifts.map(s => {
                const total = s.max_slots;
                const taken = s.registrations && s.registrations[0] ? s.registrations[0].count : 0;
                const percent = total > 0 ? (taken / total) * 100 : 0;
                const isFull = taken >= total;
                const safeShiftTitle = s.title.replace(/'/g, "\\'");

                // Badge R√©serv√© conditionnel
                const reservedBadge = s.reserved_slots > 0
                    ? `<span class="text-[10px] font-bold text-orange-600 bg-orange-100 px-1.5 py-0.5 rounded border border-orange-200 whitespace-nowrap ml-2">+${s.reserved_slots} R√©s.</span>`
                    : '';

                return `
                    <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100 relative group hover:shadow-sm transition-all">
                        
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex-1 pr-2">
                                <div class="flex items-center flex-wrap mb-1">
                                    <h4 class="font-bold text-slate-800 text-sm leading-tight">${s.title}</h4>
                                    ${reservedBadge}
                                </div>
                                <div class="text-xs text-slate-500 font-medium flex items-center gap-1">
                                    ${s.start_time.slice(0, 5)} - ${s.end_time.slice(0, 5)} 
                                    <span class="text-slate-300">‚Ä¢</span> 
                                    Ref: ${s.referent_name || 'Aucun'}
                                </div>
                            </div>

                            <div class="text-right min-w-[60px]">
                                <div class="text-xs font-bold ${isFull ? 'text-red-500' : 'text-brand-600'} mb-1">${taken} / ${total}</div>
                                <div class="h-1.5 w-16 bg-slate-200 rounded-full overflow-hidden ml-auto">
                                    <div class="h-full ${isFull ? 'bg-red-500' : 'bg-brand-500'}" style="width: ${percent}%"></div>
                                </div>
                            </div>
                        </div>

                        <div class="flex items-center justify-end gap-1 mt-3 pt-3 border-t border-slate-200/60">
                            
                            <button onclick="openEditShift(${s.id}, '${safeShiftTitle}', '${s.start_time}', '${s.end_time}', ${s.max_slots})" 
                                class="p-2 text-slate-400 hover:text-brand-600 hover:bg-white rounded-xl transition" title="Modifier">
                                <i data-lucide="pencil" class="w-4 h-4"></i>
                            </button>

                            <button onclick="openShiftQR(${s.id}, '${safeShiftTitle}')" 
                                class="p-2 text-slate-400 hover:text-slate-900 hover:bg-white rounded-xl transition" title="QR Code">
                                <i data-lucide="qr-code" class="w-4 h-4"></i>
                            </button>
                            
                            <button onclick="viewParticipants(${s.id}, '${safeShiftTitle}')" 
                                class="flex items-center gap-2 px-3 py-1.5 bg-brand-50 text-brand-600 rounded-xl hover:bg-brand-100 transition text-xs font-bold ml-2 border border-brand-100/50">
                                <i data-lucide="users" class="w-4 h-4"></i>
                                <span class="hidden sm:inline">Inscrits</span>
                            </button>

                            <button onclick="deleteSingleShift(${s.id})" 
                                class="p-2 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-xl transition ml-1" title="Supprimer">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>`;
            }).join('')}
            </div>
        </div>
    `;
        }
        function openEditEventModal(id, title, date, loc) {
            const m = document.createElement('div');
            m.id = 'edit-event-modal';
            m.className = 'fixed inset-0 bg-black/60 z-[70] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in';
            m.innerHTML = `
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-slide-up">
            <h3 class="font-bold text-lg mb-4 text-slate-900">Modifier l'√âv√©nement</h3>
            
            <form onsubmit="handleUpdateEvent(event, ${id})" class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Titre</label>
                    <input name="title" value="${title}" class="w-full p-3 bg-slate-50 rounded-xl font-bold border outline-none focus:border-brand-500" required>
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Date</label>
                    <input name="date" type="date" value="${date}" class="w-full p-3 bg-slate-50 rounded-xl font-bold border outline-none focus:border-brand-500" required>
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Lieu</label>
                    <input name="location" value="${loc}" class="w-full p-3 bg-slate-50 rounded-xl font-bold border outline-none focus:border-brand-500" required>
                </div>
                
                <div class="pt-2">
                    <button type="submit" class="w-full py-3 bg-brand-600 text-white font-bold rounded-xl shadow-lg hover:bg-brand-700 transition">Enregistrer</button>
                </div>
            </form>
            
            <button onclick="document.getElementById('edit-event-modal').remove()" class="w-full py-3 mt-2 text-slate-400 font-bold text-sm hover:bg-slate-50 rounded-xl">Annuler</button>
        </div>
    `;
            document.body.appendChild(m);
        }

        async function handleUpdateEvent(e, id) {
            e.preventDefault();
            const fd = new FormData(e.target);

            // Petite validation
            const title = fd.get('title').trim();
            const date = fd.get('date');
            const loc = fd.get('location').trim();

            if (!title || !date || !loc) return showToast("Tous les champs sont requis", "error");

            toggleLoader(true);

            try {
                const { error } = await supabase
                    .from('events')
                    .update({
                        title: title,
                        date: date,
                        location: loc
                    })
                    .eq('id', id);

                if (error) throw error;

                showToast('√âv√©nement mis √† jour !');
                document.getElementById('edit-event-modal').remove();
                renderPlanningAdmin(document.getElementById('main-slot')); // Rafra√Æchir la liste

            } catch (err) {
                console.error(err);
                showToast("Erreur lors de la mise √† jour", "error");
            } finally {
                toggleLoader(false);
            }
        }

        async function deleteEvent(id) {
            if (!confirm("‚ö†Ô∏è Attention : Supprimer l'√©v√©nement effacera TOUS les cr√©neaux et d√©sinscrira les b√©n√©voles. Continuer ?")) return;
            toggleLoader(true);

            try {
                // CORRECTION : Gr√¢ce au 'ON DELETE CASCADE' SQL, une seule requ√™te suffit.
                // La base de donn√©es supprimera automatiquement les cr√©neaux (shifts) et inscriptions li√©s.
                const { error } = await supabase.from('events').delete().eq('id', id);

                if (error) throw error;

                showToast('√âv√©nement supprim√© avec succ√®s');
                renderPlanningAdmin(document.getElementById('main-slot'));

            } catch (err) {
                console.error(err);
                showToast("Impossible de supprimer : " + err.message, "error");
            } finally {
                toggleLoader(false);
            }
        }

        function renderCreateEventModal(parent) {
            if (document.getElementById('create-event-modal')) return;

            const div = document.createElement('div');
            div.id = 'create-event-modal';
            div.className = 'fixed inset-0 bg-black/60 z-50 hidden items-center justify-center backdrop-blur-sm';

            // Liste Templates (inchang√©)
            const tpls = state.templates.map(t => `
        <button onclick="applyTemplate(${t.id})" class="flex-shrink-0 w-24 h-24 bg-slate-50 hover:bg-white hover:border-brand-500 rounded-2xl flex flex-col items-center justify-center border-2 border-slate-100 transition group mr-3 relative">
            <i data-lucide="layout-template" class="w-6 h-6 text-slate-400 group-hover:text-brand-500 mb-2 transition"></i>
            <span class="text-[10px] font-bold text-slate-600 text-center px-1 line-clamp-2">${t.name}</span>
        </button>`).join('');

            // Options Admins (inchang√©)
            const adminOpts = state.admins.map(a => `<option value="${a.first_name}">${a.first_name}</option>`).join('');

            div.innerHTML = `
        <div class="bg-white w-full max-w-2xl h-[95vh] rounded-3xl overflow-hidden flex flex-col animate-slide-up shadow-2xl">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <h3 class="text-xl font-extrabold text-slate-900">Cr√©er un √©v√©nement</h3>
                <button onclick="document.getElementById('create-event-modal').classList.add('hidden')" class="bg-white p-2 rounded-full border border-slate-200 text-slate-500 hover:text-red-500 transition">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto p-6">
                ${tpls ? `
                    <div class="mb-8">
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Mod√®les Rapides</p>
                        <div class="flex overflow-x-auto pb-4 no-scrollbar snap-x">${tpls}</div>
                    </div>
                ` : ''}

                <form id="form-create-event" onsubmit="handleCreateEvent(event)" class="space-y-6">
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs font-bold text-slate-400 uppercase ml-1">Titre de l'√©v√©nement</label>
                            <input name="title" placeholder="Ex: Distribution Alimentaire" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none focus:ring-2 focus:ring-brand-500 transition" required>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs font-bold text-slate-400 uppercase ml-1">Lieu</label>
                                <input name="location" placeholder="Ex: 2 Bd Foch" class="w-full p-4 bg-slate-50 rounded-2xl font-bold text-sm outline-none focus:ring-2 focus:ring-brand-500" required>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-400 uppercase ml-1">Date</label>
                                <input name="date" type="date" class="w-full p-4 bg-slate-50 rounded-2xl font-bold text-sm outline-none focus:ring-2 focus:ring-brand-500" required>
                            </div>
                        </div>
                    </div>

                    <div class="pt-6 border-t border-slate-100">
                        <div class="flex justify-between items-center mb-4">
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Cr√©neaux (<span id="shift-count">0</span>)</p>
                        </div>
                        
                        <div id="temp-shifts-list" class="grid gap-3 mb-6"></div>

                        <div class="bg-slate-50 p-5 rounded-2xl border-2 border-dashed border-slate-200 hover:border-brand-300 transition group">
                            <p class="text-xs font-bold text-brand-600 mb-3 uppercase">Ajouter un cr√©neau</p>
                            <div class="grid md:grid-cols-2 gap-3 mb-3">
                                <div>
                                    <label class="sr-only">Nom du cr√©neau</label>
                                    <input id="ns-title" placeholder="Nom (ex: Distribution)" class="w-full p-3 bg-white rounded-xl text-sm font-bold border-none outline-none ring-1 ring-slate-200 focus:ring-brand-500">
                                </div>
                                <div>
                                    <label class="sr-only">R√©f√©rent</label>
                                    <select id="ns-ref" class="w-full p-3 bg-white rounded-xl text-sm font-bold outline-none ring-1 ring-slate-200">
                                        <option value="">-- Choisir R√©f√©rent --</option>
                                        ${adminOpts}
                                    </select>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-3 mb-3">
                                <div>
                                    <label class="text-[10px] text-slate-400 font-bold uppercase ml-1">D√©but</label>
                                    <input id="ns-start" type="time" class="w-full p-3 bg-white rounded-xl text-sm font-bold outline-none ring-1 ring-slate-200">
                                </div>
                                <div>
                                    <label class="text-[10px] text-slate-400 font-bold uppercase ml-1">Fin</label>
                                    <input id="ns-end" type="time" class="w-full p-3 bg-white rounded-xl text-sm font-bold outline-none ring-1 ring-slate-200">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-3 mb-4">
                                <div>
                                    <label class="text-[10px] text-slate-400 font-bold uppercase ml-1">Total Places</label>
                                    <input id="ns-max" type="number" value="10" class="w-full p-3 bg-white rounded-xl text-sm font-bold outline-none ring-1 ring-slate-200">
                                </div>
                                <div>
                                    <label class="text-[10px] text-orange-400 font-bold uppercase ml-1">Dont R√©serv√©es</label>
                                    <input id="ns-res" type="number" value="0" class="w-full p-3 bg-white rounded-xl text-sm font-bold outline-none ring-1 ring-orange-200 text-orange-600">
                                </div>
                            </div>
                            <button type="button" onclick="addShift()" class="w-full py-3 bg-slate-900 text-white rounded-xl text-sm font-bold hover:bg-slate-700 transition shadow-lg">Ajouter ce cr√©neau</button>
                        </div>
                    </div>
                </form>
            </div>

            <div class="p-6 border-t border-slate-100 bg-white grid grid-cols-2 gap-4">
                <button type="button" onclick="saveTemplate()" class="py-4 bg-slate-100 text-slate-600 font-bold rounded-2xl hover:bg-slate-200 transition">Sauver en Mod√®le</button>
                <button onclick="document.getElementById('form-create-event').requestSubmit()" class="py-4 bg-brand-600 text-white font-bold rounded-2xl shadow-lg shadow-brand-200 hover:bg-brand-700 transition">Publier l'√©v√©nement</button>
            </div>
        </div>`;
            parent.appendChild(div);
        }

        // --- AUTH & DATA HANDLERS ---
        async function handleLogin(e) { e.preventDefault(); toggleLoader(true); const { error } = await supabase.auth.signInWithPassword({ email: document.getElementById('login-email').value, password: document.getElementById('login-password').value }); if (error) { showToast(error.message, 'error'); toggleLoader(false); } else window.location.reload(); }

        async function handleRegister(event) {
            event.preventDefault();

            // --- UX : Nettoyage des erreurs ---
            const inputs = document.querySelectorAll('#form-register input');
            inputs.forEach(i => i.classList.remove('ring-2', 'ring-red-500', 'bg-red-50'));

            const fn = document.getElementById('reg-fn').value.trim();
            const ln = document.getElementById('reg-ln').value.trim();
            const email = document.getElementById('reg-email').value.trim();
            const phone = document.getElementById('reg-phone').value.trim();
            const pass = document.getElementById('reg-pass').value.trim();
            const has_permit = document.getElementById('reg-permit').checked;
            const mandatory_hours = document.getElementById('reg-mandatory').checked; // true/false
            const fileInput = document.getElementById('reg-proof');

            // --- Validation Basique ---
            let hasError = false;
            if (!fn) { document.getElementById('reg-fn').classList.add('ring-2', 'ring-red-500'); hasError = true; }
            if (!ln) { document.getElementById('reg-ln').classList.add('ring-2', 'ring-red-500'); hasError = true; }
            if (!email) { document.getElementById('reg-email').classList.add('ring-2', 'ring-red-500'); hasError = true; }
            if (!pass) { document.getElementById('reg-pass').classList.add('ring-2', 'ring-red-500'); hasError = true; }
            if (!fileInput.files.length) { showToast("Justificatif requis", "error"); hasError = true; }

            if (hasError) return showToast('Veuillez remplir les champs rouges', 'error');

            toggleLoader(true);

            // --- V√©rification fichier ---
            const file = fileInput.files[0];
            if (file.size > 5 * 1024 * 1024) { toggleLoader(false); return showToast("Fichier trop lourd (Max 5 Mo)", "error"); }

            try {
                // 1. INSCRIPTION AUTH (+ Envoi des donn√©es au Trigger SQL via 'options')
                const { data: authData, error: authError } = await supabase.auth.signUp({
                    email: email,
                    password: pass,
                    options: {
                        data: {
                            first_name: fn,
                            last_name: ln,
                            phone: phone, // On envoie le t√©l√©phone ici !
                            has_permit: has_permit, // On envoie le bool√©en ici !
                            mandatory_hours: mandatory_hours // On envoie le bool√©en ici !
                        }
                    }
                });

                if (authError) throw authError;

                let user = authData.user;

                // Si l'auto-confirm est activ√©, l'user est d√©j√† connect√©. 
                // Sinon, il faut v√©rifier s'il existe.
                if (!user) throw new Error("Erreur lors de la cr√©ation de session.");

                // 2. UPLOAD DU FICHIER (Maintenant que le SQL a cr√©√© les permissions)
                // Note: Le trigger a d√©j√† cr√©√© le profil en base de donn√©es √† cette √©tape.
                const { error: uploadError } = await supabase.storage
                    .from('proofs')
                    .upload(user.id, file, { upsert: true });

                if (uploadError) {
                    console.error("Erreur Upload:", uploadError);
                    // On ne bloque pas tout pour √ßa, mais on pr√©vient
                    showToast("Compte cr√©√© mais erreur d'envoi du fichier.", "warning");
                } else {
                    showToast("Inscription r√©ussie ! Bienvenue.", "success");
                }

                // 3. RELOAD pour entrer dans l'application
                setTimeout(() => window.location.reload(), 1000);

            } catch (err) {
                console.error(err);
                toggleLoader(false);
                showToast(err.message || "Erreur inscription", "error");
            }
        }

        // Affiche la belle fen√™tre de suppression
        function openDeleteAccountModal() {
            const m = document.createElement('div');
            m.id = 'delete-account-modal';
            m.className = 'fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in';

            m.innerHTML = `
        <div class="bg-white w-full max-w-sm rounded-[2rem] p-6 shadow-2xl animate-slide-up relative overflow-hidden">
            
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-red-500 to-orange-500"></div>

            <div class="text-center">
                <div class="w-20 h-20 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 border-4 border-red-100 shadow-sm">
                    <i data-lucide="alert-triangle" class="w-10 h-10"></i>
                </div>

                <h3 class="text-xl font-extrabold text-slate-900 mb-2">Supprimer le compte ?</h3>
                
                <p class="text-sm text-slate-500 mb-6 leading-relaxed">
                    Cette action est <span class="font-bold text-red-500">irr√©versible</span>. 
                    Toutes vos donn√©es (historique, heures, profil) seront effac√©es d√©finitivement.
                </p>

                <div class="bg-slate-50 p-4 rounded-xl text-left border border-slate-200 mb-6">
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1 mb-1 block">Confirmez votre email</label>
                    <input id="delete-confirm-email" type="email" placeholder="${state.user.email}" class="w-full p-3 bg-white rounded-lg font-bold text-sm outline-none border border-slate-200 focus:border-red-500 focus:ring-4 focus:ring-red-500/10 transition placeholder:text-slate-300">
                </div>

                <div class="flex gap-3">
                    <button onclick="document.getElementById('delete-account-modal').remove()" class="flex-1 py-3.5 bg-slate-100 text-slate-600 font-bold rounded-xl hover:bg-slate-200 transition">
                        Annuler
                    </button>
                    <button onclick="confirmDeleteAccount()" class="flex-1 py-3.5 bg-red-600 text-white font-bold rounded-xl shadow-lg shadow-red-200 hover:bg-red-700 active:scale-95 transition flex items-center justify-center gap-2">
                        <i data-lucide="trash-2" class="w-4 h-4"></i> Supprimer
                    </button>
                </div>
            </div>
        </div>
    `;

            document.body.appendChild(m);
            lucide.createIcons();
        }

        // G√®re la logique de suppression
        async function confirmDeleteAccount() {
            const input = document.getElementById('delete-confirm-email');
            const val = input.value.trim();

            // V√©rification de s√©curit√©
            if (val !== state.user.email) {
                input.classList.add('ring-2', 'ring-red-500', 'bg-red-50');
                showToast("L'email ne correspond pas.", "error");
                setTimeout(() => input.classList.remove('ring-2', 'ring-red-500', 'bg-red-50'), 2000);
                return;
            }

            toggleLoader(true);

            try {
                // Appel de la fonction SQL s√©curis√©e
                const { error } = await supabase.rpc('delete_own_account');

                if (error) throw error;

                // Nettoyage complet
                localStorage.clear();
                sessionStorage.clear();

                // Fermeture modale
                const m = document.getElementById('delete-account-modal');
                if (m) m.remove();

                alert("Compte supprim√© avec succ√®s. Au revoir !");
                window.location.reload();

            } catch (err) {
                console.error("Erreur suppression:", err);
                showToast("Erreur technique : " + err.message, "error");
                toggleLoader(false);
            }
        }

        // REMPLACER LA FONCTION handleShiftAction PAR CELLE-CI :
        async function handleShiftAction(shiftId, action) {
            try {
                if (action === 'register') {
                    // Appel RPC s√©curis√©
                    const { data, error } = await supabase.rpc('register_to_shift', {
                        p_user_id: state.user.id,  // Notez le 'p_'
                        p_shift_id: shiftId        // Notez le 'p_'
                    });

                    if (error) throw error;
                    showToast('Inscription valid√©e !', 'success');
                }
                else if (action === 'unregister') {
                    // D√©sinscription standard (autoris√©e par RLS)
                    const { error } = await supabase
                        .from('registrations')
                        .delete()
                        .eq('user_id', state.user.id)
                        .eq('shift_id', shiftId);

                    if (error) throw error;
                    showToast('D√©sinscription prise en compte.');
                }

                // Rafra√Æchir l'affichage
                loadUserProfile(); // Pour mettre √† jour les heures/compteurs
                const mainSlot = document.getElementById('main-slot');
                if (mainSlot) renderEvents(mainSlot);

            } catch (err) {
                console.error(err);
                showToast(err.message || "Impossible de traiter la demande", 'error');
            }
        }

        async function handleForgot() {
            const m = prompt("Email ?");
            if (!m) return;
            try {
                toggleLoader(true);
                // Utilise la m√©thode v2 si disponible, sinon fallback sur resetPasswordForEmail
                let result;
                if (supabase.auth.resetPasswordForEmail) {
                    result = await supabase.auth.resetPasswordForEmail(m, { redirectTo: window.location.href });
                } else if (supabase.auth.api && supabase.auth.api.resetPasswordForEmail) {
                    result = await supabase.auth.api.resetPasswordForEmail(m, { redirectTo: window.location.href });
                } else {
                    throw new Error('M√©thode reset password non disponible (v√©rifier la version du SDK Supabase)');
                }
                toggleLoader(false);
                const error = result?.error || null;
                if (error) return showToast(error.message || 'Erreur envoi email', 'error');
                showToast('Email de r√©initialisation envoy√©', 'success');
            } catch (err) {
                toggleLoader(false);
                console.error('handleForgot error', err);
                showToast('Erreur lors de la demande', 'error');
            }
        }

        function handleLogout() {
            // On utilise notre nouvelle belle modale
            openConfirmModal(
                "D√©connexion",
                "Voulez-vous vraiment vous d√©connecter de l'application ?",
                async () => {
                    // --- C'EST ICI QUE SE PASSE L'ACTION UNE FOIS CONFIRM√â ---
                    toggleLoader(true);
                    try {
                        await supabase.auth.signOut();
                        localStorage.removeItem('cop1_last_view');
                        localStorage.removeItem('cop1_admin_mode');

                        // Nettoyage complet
                        const keysToRemove = [];
                        for (let i = 0; i < localStorage.length; i++) {
                            const key = localStorage.key(i);
                            if (key && key.startsWith('sb-')) keysToRemove.push(key);
                        }
                        keysToRemove.forEach(k => localStorage.removeItem(k));

                        sessionStorage.clear();
                        window.location.reload();
                    } catch (err) {
                        window.location.reload();
                    }
                },
                true // True = bouton rouge (car on quitte)
            );
        }
        // --- EVENT CREATION LOGIC ---
        function addShift() {
            const t = document.getElementById('ns-title').value;
            const s = document.getElementById('ns-start').value;
            const e = document.getElementById('ns-end').value;
            const max = document.getElementById('ns-max').value;
            const res = document.getElementById('ns-res').value;
            const ref = document.getElementById('ns-ref').value;

            if (!t || !s || !e) return showToast('Titre et horaires requis', 'error');

            state.tempShifts.push({
                id: Date.now(),
                title: t,
                start_time: s,
                end_time: e,
                max_slots: parseInt(max) || 10,
                reserved_slots: parseInt(res) || 0,
                referent_name: ref
            });

            renderTempShifts();
            // Reset champs principaux
            document.getElementById('ns-title').value = '';
        }

        function renderTempShifts() {
            document.getElementById('temp-shifts-list').innerHTML = state.tempShifts.map(s => `
                <div class="bg-white p-3 rounded-xl border border-slate-100 flex justify-between items-center shadow-sm">
                    <div>
                        <div class="text-sm font-bold text-slate-800">${s.title}</div>
                        <div class="text-xs text-slate-500">${s.start_time} - ${s.end_time} ‚Ä¢ ${s.max_slots} places (${s.reserved_slots} r√©s.)</div>
                        ${s.referent_name ? `<div class="text-[10px] text-brand-600 font-bold bg-brand-50 inline-block px-1 rounded mt-1">Ref: ${s.referent_name}</div>` : ''}
                    </div>
                    <button onclick="removeShift(${s.id})" class="text-red-400 bg-red-50 p-2 rounded-lg hover:bg-red-100"><i data-lucide="trash" class="w-4 h-4"></i></button>
                </div>`).join('');
            document.getElementById('shift-count').innerText = state.tempShifts.length;
            lucide.createIcons();
        }

        function removeShift(id) { state.tempShifts = state.tempShifts.filter(s => s.id !== id); renderTempShifts(); }

        async function handleCreateEvent(e) {
            e.preventDefault();

            // S√âCURIT√â : Gardien Admin
            if (!state.profile?.is_admin) return showToast("Action non autoris√©e", "error");

            if (!state.tempShifts.length) return showToast('Aucun cr√©neau configur√©', 'error');

            toggleLoader(true);
            const form = e.target;

            // 1. Cr√©ation de l'√©v√©nement parent
            const { data: evt, error } = await supabase
                .from('events')
                .insert([{
                    title: form.title.value,
                    location: form.location.value,
                    date: form.date.value
                }])
                .select()
                .single();

            if (error) {
                showToast(error.message, 'error');
                toggleLoader(false);
                return;
            }

            // 2. Pr√©paration des cr√©neaux (Shifts) avec calcul des heures
            const shifts = state.tempShifts.map(s => {
                const d1 = new Date(`1970-01-01T${s.start_time}:00`);
                const d2 = new Date(`1970-01-01T${s.end_time}:00`);

                // Calcul de la dur√©e en heures (ex: 2h30 = 2.5)
                const duration = parseFloat((Math.abs(d2 - d1) / 36e5).toFixed(2));

                return {
                    event_id: evt.id,
                    title: s.title,
                    start_time: s.start_time,
                    end_time: s.end_time,
                    max_slots: s.max_slots,
                    reserved_slots: s.reserved_slots,
                    referent_name: s.referent_name, // <--- CRUCIAL : Le nom du responsable
                    hours_value: duration           // <--- CRUCIAL : Pour le compteur d'heures auto
                };
            });

            // 3. Insertion des cr√©neaux
            const { error: shiftError } = await supabase.from('shifts').insert(shifts);

            if (shiftError) {
                console.error(shiftError);
                showToast("Erreur lors de la cr√©ation des cr√©neaux", "error");
            } else {
                showToast('√âv√©nement publi√© avec succ√®s !');
                document.getElementById('create-event-modal').classList.add('hidden');
                state.tempShifts = [];
                setView('admin_events');
            }

            toggleLoader(false);
        }
        async function saveTemplate() {
            const t = document.querySelector('[name=title]').value; if (!t || !state.tempShifts.length) return showToast('Titre + Cr√©neaux requis', 'error');
            await supabase.from('event_templates').insert([{ name: prompt('Nom du mod√®le ?', t), event_title: t, event_location: document.querySelector('[name=location]').value, shifts_config: state.tempShifts }]);
            showToast('Mod√®le sauvegard√©'); loadTemplates();
        }

        function applyTemplate(id) {
            const t = state.templates.find(x => x.id === id);
            if (!t) return;
            if (confirm('Appliquer le mod√®le ? Cela effacera les champs actuels.')) {
                document.querySelector('[name=title]').value = t.event_title || '';
                document.querySelector('[name=location]').value = t.event_location || '';
                // On reg√©n√®re des IDs uniques pour √©viter les bugs
                state.tempShifts = t.shifts_config.map(s => ({ ...s, id: Math.random() }));
                renderTempShifts();
                showToast('Mod√®le appliqu√©');
            }
        }

        // --- COOKIES ---
        function checkCookieConsent() {
            if (!localStorage.getItem('cookie_consent')) {
                const b = document.createElement('div'); b.id = 'cookie-banner'; b.className = 'fixed bottom-0 w-full bg-white p-6 rounded-t-3xl shadow-[0_-10px_40px_rgba(0,0,0,0.1)] z-[100] animate-slide-up flex flex-col md:flex-row gap-4 items-center justify-between';
                b.innerHTML = `<div class="text-sm text-slate-500 font-medium">üç™ On utilise des cookies pour l'auth et la traduction.</div><button onclick="acceptCookies()" class="px-6 py-3 bg-slate-900 text-white font-bold rounded-xl text-sm">Accepter</button>`;
                document.body.appendChild(b);
            }
        }
        function acceptCookies() { localStorage.setItem('cookie_consent', 'ok'); document.getElementById('cookie-banner').remove(); }

        // --- SCANNER & MISC ---
        function openScanner() {
            // 1. Cr√©ation de l'interface
            const m = document.createElement('div');
            m.id = 'scanner-overlay';
            m.className = "fixed inset-0 bg-black z-[200] flex flex-col items-center justify-center animate-fade-in";

            // On injecte un style CSS temporaire pour forcer la vid√©o √† bien se comporter
            const style = document.createElement('style');
            style.id = 'scanner-css';
            style.innerHTML = `
        #qr-reader video { object-fit: cover; width: 100% !important; height: 100% !important; border-radius: 1.5rem; }
        #qr-reader { border: none !important; width: 100% !important; height: 100% !important; }
    `;
            document.head.appendChild(style);

            m.innerHTML = `
        <button onclick="closeScanner()" class="absolute top-6 right-6 text-white bg-black/40 hover:bg-black/60 p-3 rounded-full backdrop-blur-md transition z-50 border border-white/10">
            <i data-lucide="x" class="w-6 h-6"></i>
        </button>
        
        <h3 class="absolute top-16 text-white font-bold text-lg tracking-wide z-50 drop-shadow-md text-center w-full px-4">
            Visez le QR Code
        </h3>
        
        <div class="relative w-full max-w-sm aspect-[3/4] rounded-3xl overflow-hidden shadow-2xl mx-4 bg-black">
            
            <div id="qr-reader" class="w-full h-full bg-black"></div>

            <div class="absolute inset-0 border-[3rem] border-black/50 z-10 pointer-events-none"></div>
            
            <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-64 h-64 border-2 border-brand-500 rounded-3xl z-20 opacity-80 shadow-[0_0_15px_rgba(59,130,246,0.5)]">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-brand-400 to-transparent opacity-50 animate-scan"></div>
            </div>
        </div>

        <p class="text-white/60 mt-8 text-xs font-medium px-10 text-center max-w-xs mx-auto">
            Placez le code du b√©n√©vole dans le carr√© bleu.
        </p>
    `;

            document.body.appendChild(m);
            lucide.createIcons();

            // 2. D√©marrage de la cam√©ra avec une config plus large
            html5QrcodeScanner = new Html5Qrcode("qr-reader");

            // Calcul de la taille id√©ale (70% de la largeur de l'√©cran)
            const width = Math.min(window.innerWidth * 0.8, 300);

            const config = {
                fps: 10,
                qrbox: { width: width, height: width },
                aspectRatio: 1.0 // Force le ratio carr√© pour √©viter les d√©formations
            };

            html5QrcodeScanner.start({ facingMode: "environment" }, config, onScanSuccess)
                .catch(err => {
                    console.error(err);
                    closeScanner();
                    showToast("Impossible d'acc√©der √† la cam√©ra. V√©rifiez les permissions.", "error");
                });
        }

        function closeScanner() {
            // Nettoyage du CSS inject√©
            const style = document.getElementById('scanner-css');
            if (style) style.remove();

            if (html5QrcodeScanner) {
                html5QrcodeScanner.stop().then(() => {
                    html5QrcodeScanner.clear();
                    const el = document.getElementById('scanner-overlay');
                    if (el) el.remove();
                }).catch(err => {
                    console.log("Erreur arr√™t scanner (probablement d√©j√† arr√™t√©)", err);
                    const el = document.getElementById('scanner-overlay');
                    if (el) el.remove();
                });
            } else {
                const el = document.getElementById('scanner-overlay');
                if (el) el.remove();
            }
        }

        async function onScanSuccess(decodedText) {
            closeScanner();
            try {
                const data = JSON.parse(decodedText);

                // V√©rification du type de QR Code
                if (data.type === 'attendance_validation') {
                    toggleLoader(true);
                    await validateAttendance(data.shift_id);
                    toggleLoader(false);
                } else {
                    showToast('QR Code non reconnu', 'error');
                }
            } catch (e) {
                showToast('Format QR Code invalide', 'error');
            }
        }

        async function validateAttendance(shiftId) {
            if (!confirm("Confirmer la pr√©sence pour ce cr√©neau ?")) return;

            try {
                const { data, error } = await supabase.rpc('validate_attendance', {
                    p_shift_id: shiftId,
                    p_user_id: state.user.id
                });

                if (error) throw error;

                if (data.penalty) {
                    alert("‚ö†Ô∏è ALERTE QUOTA SCOLAIRE\n\n" + data.message + "\n\nHeures comptabilis√©es : 0h.");
                    showToast("Valid√© (0h - Hors Quota)", "warning");
                } else {
                    showToast(`C'est tout bon ! (+${data.hours_added}h)`);
                }

                // CORRECTION : Utilisation des bonnes fonctions de rafra√Æchissement
                await loadUserProfile(); // Met √† jour le compteur d'heures
                setView('dashboard');    // Recharge la vue dashboard proprement

            } catch (err) {
                console.error(err);
                showToast(err.message || "Erreur validation", 'error');
            }
        }

        // --- ADMIN DETAILS MODAL ---
        function viewUserDetails(uid) {
            const u = state.allUsers.find(x => x.id === uid);
            if (!u) return;

            // Trouver le nom du p√¥le s'il en a un
            const team = state.teams.find(t => t.id === u.pole_id);
            const teamName = team ? team.name : 'Aucun p√¥le';

            const m = document.createElement('div');
            m.id = 'user-details-modal';
            m.className = 'fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in';

            m.innerHTML = `
                <div class="bg-white w-full max-w-sm rounded-[2rem] overflow-hidden shadow-2xl animate-slide-up">
                    <div class="bg-brand-600 p-8 text-center text-white relative">
                        <button onclick="document.getElementById('user-details-modal').remove()" class="absolute top-4 right-4 bg-white/20 p-2 rounded-full hover:bg-white/30 transition">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                        <div class="w-20 h-20 bg-white text-brand-600 rounded-full flex items-center justify-center text-3xl font-extrabold mx-auto mb-3 shadow-lg border-4 border-brand-400">
                            ${u.first_name[0]}
                        </div>
                        <h2 class="text-xl font-bold">${u.first_name} ${u.last_name}</h2>
                        <p class="opacity-80 text-xs font-medium">${u.email}</p>
                    </div>

                    <div class="p-6 space-y-4 max-h-[60vh] overflow-y-auto">
                        <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100 text-sm space-y-2">
                            <div class="flex justify-between"><span class="text-slate-400">T√©l√©phone</span> <span class="font-bold">${u.phone || '-'}</span></div>
                            <div class="flex justify-between"><span class="text-slate-400">Statut</span> <span class="font-bold ${u.status === 'approved' ? 'text-green-600' : 'text-orange-500'}">${u.status === 'approved' ? 'Actif' : 'En attente'}</span></div>
                            <div class="flex justify-between"><span class="text-slate-400">Total Heures</span> <span class="font-bold text-brand-600">${u.total_hours || 0}h</span></div>
                        </div>

                        <div class="bg-white border-2 border-slate-100 p-4 rounded-2xl">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="bg-slate-100 p-2 rounded-lg"><i data-lucide="briefcase" class="w-4 h-4 text-slate-600"></i></div>
                                <div>
                                    <div class="font-bold text-sm text-slate-900">${u.role_title || 'B√©n√©vole'}</div>
                                    <div class="text-xs text-slate-500">${teamName}</div>
                                </div>
                            </div>
                            ${state.profile.is_admin ? `<button onclick="openRoleModal('${u.id}')" class="w-full py-2 bg-slate-900 text-white text-xs font-bold rounded-xl hover:bg-slate-700 transition">Modifier R√¥le / P√¥le</button>` : ''}
                        </div>

                        <div class="bg-yellow-50 p-4 rounded-2xl border border-yellow-200 relative">
                            <label class="text-[10px] font-bold text-yellow-700 uppercase mb-1 block flex items-center gap-1"><i data-lucide="sticky-note" class="w-3 h-3"></i> Note Interne (Responsable)</label>
                            <textarea id="admin-note-${u.id}" class="w-full bg-white p-3 rounded-xl text-sm outline-none border border-yellow-200 text-slate-700 placeholder-yellow-300/50" rows="3" placeholder="Note sur le b√©n√©vole...">${u.admin_note || ''}</textarea>
                            <button onclick="saveNote('${u.id}')" class="mt-2 w-full py-2 bg-yellow-400 text-yellow-900 font-bold rounded-lg text-xs hover:bg-yellow-500 transition shadow-sm">Enregistrer la note</button>
                        </div>
                        
                        <button onclick="viewUserHistory('${u.id}')" class="w-full py-3 text-slate-400 font-bold text-xs hover:bg-slate-50 rounded-xl transition">Voir son historique</button>
                    </div>
                </div>
            `;
            document.body.appendChild(m);
            lucide.createIcons();
        }

        async function saveNote(uid) {
            // S√âCURIT√â : Gardien Admin
            if (!state.profile?.is_admin) return showToast("Acc√®s interdit", "error");

            const note = document.getElementById(`admin-note-${uid}`).value;
            toggleLoader(true);

            const { error } = await supabase.from('profiles').update({ admin_note: note }).eq('id', uid);

            if (error) {
                toggleLoader(false);
                return showToast("Erreur sauvegarde note", "error");
            }

            // Update local state
            const u = state.allUsers.find(x => x.id === uid);
            if (u) u.admin_note = note;

            showToast('Note sauvegard√©e');
            toggleLoader(false);
        }

        function openRoleModal(uid) {
            const u = state.allUsers.find(x => x.id === uid);
            // On ferme la modale d√©tails temporairement ou on affiche par dessus (z-index sup√©rieur)
            const m = document.createElement('div');
            m.className = 'fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4 animate-fade-in';

            const opts = state.teams.map(t => `<option value="${t.id}" ${u.pole_id === t.id ? 'selected' : ''}>${t.name}</option>`).join('');

            m.innerHTML = `
                <div class="bg-white w-full max-w-xs rounded-3xl p-6 shadow-2xl animate-slide-up">
                    <h3 class="font-extrabold text-lg mb-4 text-slate-900">Modifier le R√¥le</h3>
                    <form onsubmit="handleRole(event, '${uid}')" class="space-y-3">
                        <div>
                            <label class="text-xs font-bold text-slate-400 uppercase ml-1">Titre du poste</label>
                            <input id="role-t" value="${u.role_title || ''}" placeholder="Ex: Resp. Logistique" class="w-full p-3 bg-slate-50 rounded-xl text-sm font-bold outline-none border focus:border-brand-500">
                        </div>
                        
                        <div>
                            <label class="text-xs font-bold text-slate-400 uppercase ml-1">P√¥le de rattachement</label>
                            <select id="role-p" class="w-full p-3 bg-slate-50 rounded-xl text-sm font-bold outline-none border focus:border-brand-500">
                                <option value="">Aucun P√¥le</option>
                                ${opts}
                            </select>
                        </div>

                        <div class="p-3 bg-slate-50 rounded-xl flex items-center justify-between">
                            <span class="text-sm font-bold text-slate-700">Privil√®ges Admin</span>
                            <input type="checkbox" id="role-admin" ${u.is_admin ? 'checked' : ''} class="w-5 h-5 text-brand-600 rounded">
                        </div>

                        <button type="submit" class="w-full py-3 bg-brand-600 text-white font-bold rounded-xl shadow-lg mt-2">Sauvegarder</button>
                    </form>
                    <button onclick="this.closest('.fixed').remove()" class="mt-3 w-full py-3 text-slate-400 font-bold text-sm hover:bg-slate-50 rounded-xl">Annuler</button>
                </div>
            `;
            document.body.appendChild(m);
        }

        async function handleRole(e, uid) {
            e.preventDefault();

            // S√âCURIT√â : Gardien Admin
            if (!state.profile?.is_admin) return showToast("Seul un admin peut modifier les r√¥les.", "error");

            toggleLoader(true);
            const title = document.getElementById('role-t').value;
            const pole = document.getElementById('role-p').value || null;
            const isAdmin = document.getElementById('role-admin').checked;

            const { error } = await supabase.from('profiles').update({
                role_title: title,
                pole_id: pole,
                is_admin: isAdmin
            }).eq('id', uid);

            if (error) {
                toggleLoader(false);
                return showToast("Erreur modification : " + error.message, "error");
            }

            // Update local state
            const u = state.allUsers.find(x => x.id === uid);
            if (u) { u.role_title = title; u.pole_id = parseInt(pole); u.is_admin = isAdmin; }

            showToast('R√¥le mis √† jour avec succ√®s');

            // Fermer la modale R√¥le
            const roleModal = document.querySelector('.fixed.z-\\[60\\]');
            if (roleModal) roleModal.remove();

            // Rafra√Æchir la modale D√©tails si elle est ouverte
            const detailsModal = document.getElementById('user-details-modal');
            if (detailsModal) {
                detailsModal.remove();
                viewUserDetails(uid);
            }

            renderAnnuaire(document.getElementById('main-slot'));
            toggleLoader(false);
        }

        // --- EXTRA FUNCTIONS ---
        function renderPendingView() {
            document.getElementById('root').innerHTML = `
        <div class="min-h-screen flex flex-col items-center justify-center p-6 text-center animate-fade-in">
            
            <div class="w-24 h-24 bg-orange-50 text-orange-500 rounded-full flex items-center justify-center mb-6 shadow-sm border border-orange-100">
                <i data-lucide="clock" class="w-10 h-10"></i>
            </div>
            
            <h2 class="text-2xl font-extrabold text-slate-900 mb-2">Inscription en attente</h2>
            
            <p class="text-slate-500 text-sm mb-8 max-w-xs mx-auto">
                Merci de votre patience ! Un administrateur de COP1 Angers doit valider votre dossier avant que vous puissiez acc√©der au planning.
            </p>

            <div class="w-full max-w-xs space-y-3">
                <button onclick="location.reload()" class="w-full py-3.5 bg-slate-900 text-white font-bold rounded-2xl shadow-lg hover:bg-slate-800 transition flex items-center justify-center gap-2">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i> V√©rifier maintenant
                </button>
                
                <button onclick="handleLogout()" class="w-full py-3.5 text-red-500 font-bold text-sm hover:bg-red-50 rounded-2xl transition flex items-center justify-center gap-2">
                    <i data-lucide="log-out" class="w-4 h-4"></i> Se d√©connecter
                </button>
            </div>

        </div>
    `;
            lucide.createIcons();
        }
        function renderRejectedView() { document.getElementById('root').innerHTML = `<div class="min-h-screen flex flex-col items-center justify-center p-6 text-center"><div class="w-20 h-20 bg-red-100 text-red-500 rounded-full flex items-center justify-center mb-4"><i data-lucide="x-circle" class="w-10 h-10"></i></div><h2 class="text-xl font-bold">Acc√®s refus√©</h2><button onclick="handleLogout()" class="mt-6 text-red-500 font-bold">D√©connexion</button></div>`; lucide.createIcons(); }
        function getLegalContent(type) {
            const backBtn = `<button onclick="state.user ? setView('profile') : renderLogin()" class="mb-6 flex items-center gap-2 text-brand-600 font-bold text-sm hover:bg-brand-50 px-3 py-2 rounded-xl transition"><i data-lucide="arrow-left" class="w-4 h-4"></i> Retour</button>`;

            if (type === 'mentions') {
                return `
            ${backBtn}
            <div class="animate-fade-in max-w-2xl mx-auto pb-20">
                <h2 class="text-2xl font-extrabold text-slate-900 mb-6">Mentions L√©gales</h2>
                <div class="space-y-6 text-sm text-slate-600 bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                    <section>
                        <h3 class="font-bold text-slate-900 text-base mb-2">1. √âditeur du site</h3>
                        <p><strong>Association COP1 Angers</strong></p>
                        <p>Association loi 1901 √† but non lucratif.</p>
                        <p>Si√®ge social : Angers, France</p>
                        <p>Contact : via la messagerie interne de l'application.</p>
                    </section>
                    <section>
                        <h3 class="font-bold text-slate-900 text-base mb-2">2. H√©bergement & Donn√©es</h3>
                        <p>L'application est h√©berg√©e techniquement (Frontend) sur le navigateur client.</p>
                        <p>Les donn√©es et l'authentification sont h√©berg√©es par :</p>
                        <p><strong>Supabase Inc.</strong> (bas√© sur AWS)<br>
                        San Francisco, California, USA.<br>
                        Conforme RGPD (Data Processing Addendum).</p>
                    </section>
                    <section>
                        <h3 class="font-bold text-slate-900 text-base mb-2">3. Propri√©t√© intellectuelle</h3>
                        <p>Le logo et le nom COP1 Angers sont la propri√©t√© de l'association. Toute reproduction interdite.</p>
                    </section>
                </div>
            </div>
        `;
            }
            // ... (Le reste : privacy et cgu ne changent pas, garde ton code original pour la suite du 'else if')
            // Pour simplifier le copier-coller, assure-toi de garder les blocs 'privacy' et 'cgu' existants apr√®s ce bloc.
            // Si tu veux, copie juste le bloc 'mentions' ci-dessus.
            else if (type === 'privacy') {
                // ... (Ton code actuel pour privacy) ...
                return `
            ${backBtn}
            <div class="animate-fade-in max-w-2xl mx-auto pb-20">
                <h2 class="text-2xl font-extrabold text-slate-900 mb-6">Politique de Confidentialit√©</h2>
                <div class="space-y-6 text-sm text-slate-600 bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                    <section>
                        <h3 class="font-bold text-slate-900 text-base mb-2">1. Donn√©es collect√©es</h3>
                        <p>Dans le cadre de votre inscription b√©n√©vole, nous collectons via le formulaire :</p>
                        <ul class="list-disc pl-5 mt-1 space-y-1">
                            <li>Identit√© : Nom, Pr√©nom.</li>
                            <li>Contact : Email, T√©l√©phone.</li>
                            <li>Statut : Possession du Permis B (pour les missions de conduite).</li>
                            <li>Documents : Justificatif de statut -26 ans (supprim√© apr√®s validation pour les non-retenus).</li>
                            <li>Technique : Adresse IP (s√©curit√© Supabase).</li>
                        </ul>
                    </section>
                    <section>
                        <h3 class="font-bold text-slate-900 text-base mb-2">2. Utilisation des donn√©es</h3>
                        <p>Ces donn√©es servent uniquement √† :</p>
                        <ul class="list-disc pl-5 mt-1 space-y-1">
                            <li>G√©rer le planning des distributions.</li>
                            <li>Valider vos heures de b√©n√©volat (attestations √©coles).</li>
                            <li>Vous contacter en cas d'urgence sur une mission.</li>
                        </ul>
                    </section>
                    <section>
                        <h3 class="font-bold text-slate-900 text-base mb-2">3. Dur√©e de conservation</h3>
                        <p>Les comptes inactifs depuis plus de 3 ans sont anonymis√©s. Les justificatifs refus√©s sont supprim√©s imm√©diatement.</p>
                    </section>
                    <section>
                        <h3 class="font-bold text-slate-900 text-base mb-2">4. Cookies & Services Tiers</h3>
                        <p><strong>Essentiels :</strong> Cookies de session Supabase (connexion).</p>
                    </section>
                    <section>
                        <h3 class="font-bold text-slate-900 text-base mb-2">5. Vos droits</h3>
                        <p>Vous pouvez modifier vos informations directement dans l'onglet "Profil". Pour supprimer votre compte, contactez un administrateur via la messagerie.</p>
                    </section>
                </div>
            </div>
        `;
            } else if (type === 'cgu') {
                return `
            ${backBtn}
            <div class="animate-fade-in max-w-2xl mx-auto pb-20">
                <h2 class="text-2xl font-extrabold text-slate-900 mb-6">Conditions d'Utilisation</h2>
                <div class="space-y-6 text-sm text-slate-600 bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                    <p>L'utilisation de l'Espace B√©n√©voles COP1 Angers implique l'acceptation de ces r√®gles :</p>
                    <div class="bg-orange-50 p-4 rounded-xl border border-orange-100 text-orange-800">
                        <h4 class="font-bold mb-1">Engagement B√©n√©vole</h4>
                        <p>Toute inscription √† une mission (distribution, collecte...) est un engagement ferme. En cas d'emp√™chement, vous devez vous d√©sinscrire au moins 24h √† l'avance pour ne pas p√©naliser l'√©quipe.</p>
                    </div>
                    <ul class="list-disc pl-5 space-y-2 mt-4">
                        <li><strong>Respect :</strong> Courtoisie obligatoire envers les b√©n√©ficiaires et les autres b√©n√©voles.</li>
                        <li><strong>S√©curit√© :</strong> Respect strict des consignes donn√©es par les r√©f√©rents lors des missions.</li>
                        <li><strong>Confidentialit√© :</strong> Interdiction de divulguer des informations sur les b√©n√©ficiaires rencontr√©s.</li>
                        <li><strong>Exactitude :</strong> Vous certifiez que les documents fournis (Permis B, preuve d'√¢ge) sont authentiques.</li>
                    </ul>
                </div>
            </div>
        `;
            }
        }

        function openCreateEventModal() { renderCreateEventModal(document.body); document.getElementById('create-event-modal').classList.remove('hidden'); }

        async function validate(id, ok) {
            // Demande de confirmation
            if (!confirm(ok ? "Valider ce b√©n√©vole ? (Le justificatif sera supprim√©)" : "Refuser l'inscription ?")) return;

            toggleLoader(true);

            try {
                // 1. SUPPRESSION DU FICHIER (Nettoyage du stockage)
                // On cible directement le fichier nomm√© avec l'ID de l'utilisateur
                // On ne s'inqui√®te pas s'il n'existe pas (le code continue)
                const { error: deleteError } = await supabase.storage
                    .from(BUCKET_PROOF)
                    .remove([id]); // Le nom du fichier est l'ID

                if (deleteError) {
                    console.warn("Fichier introuvable ou erreur suppression :", deleteError);
                }

                // 2. MISE √Ä JOUR DU PROFIL EN BASE
                // On change le statut : 'approved' si ok, 'rejected' sinon
                const { error: updateError } = await supabase
                    .from('profiles')
                    .update({ status: ok ? 'approved' : 'rejected' })
                    .eq('id', id);

                if (updateError) throw updateError;

                // 3. ACTUALISATION DE L'INTERFACE
                showToast(ok ? "Compte valid√© !" : "Compte refus√©.");

                // On met √† jour la liste locale pour √©viter de recharger toute la page
                const userIndex = state.allUsers.findIndex(u => u.id === id);
                if (userIndex !== -1) {
                    state.allUsers[userIndex].status = ok ? 'approved' : 'rejected';
                }

                // On rafra√Æchit l'affichage de l'annuaire
                renderAnnuaire(document.getElementById('main-slot'));

            } catch (err) {
                console.error(err);
                showToast("Erreur : " + (err.message || "Impossible de mettre √† jour"), "error");
            } finally {
                toggleLoader(false);
            }
        }

        async function openProof(userId) {
            if (!userId) return showToast("Erreur ID utilisateur", "error");
            toggleLoader(true);

            try {
                // 1. R√©cup√©ration de l'URL sign√©e (valide 1h)
                const { data, error } = await supabase.storage
                    .from('proofs') // Ton bucket
                    .createSignedUrl(userId, 3600);

                if (error || !data?.signedUrl) {
                    console.error(error);
                    showToast("Document introuvable ou erreur.", "error");
                } else {
                    // 2. Ouvrir la modale personnalis√©e
                    openDocumentViewer(data.signedUrl, userId);
                }
            } catch (err) {
                console.error(err);
                showToast("Erreur technique", "error");
            } finally {
                toggleLoader(false);
            }
        }

        function openDocumentViewer(url, userId) {
            // D√©tection basique du type (Supabase renvoie souvent le content-type, mais ici on devine par l'URL ou on force l'affichage)
            // L'astuce : <object> ou <iframe> g√®rent bien le PDF nativement sur Desktop.

            const m = document.createElement('div');
            m.id = 'doc-viewer-modal';
            m.className = 'fixed inset-0 bg-slate-900/95 z-[100] flex flex-col items-center justify-center p-4 backdrop-blur-sm animate-fade-in';

            m.innerHTML = `
        <div class="absolute top-4 right-4 flex gap-3 z-50">
            <a href="${url}" download="justificatif_${userId}" class="bg-white/10 text-white p-3 rounded-full hover:bg-white/20 transition backdrop-blur-md" title="T√©l√©charger">
                <i data-lucide="download" class="w-5 h-5"></i>
            </a>
            <button onclick="document.getElementById('doc-viewer-modal').remove()" class="bg-white/10 text-white p-3 rounded-full hover:bg-red-500/80 transition backdrop-blur-md">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>

        <div class="w-full h-full max-w-4xl max-h-[80vh] bg-white rounded-lg shadow-2xl overflow-hidden flex items-center justify-center relative">
            <object data="${url}" type="application/pdf" class="w-full h-full object-contain">
                <img src="${url}" class="w-full h-full object-contain bg-slate-800" alt="Justificatif">
            </object>
        </div>

        <div class="absolute bottom-8 flex gap-4 animate-slide-up">
            <button onclick="handleViewerAction('${userId}', false)" class="px-6 py-3 bg-red-500 text-white font-bold rounded-full shadow-lg hover:bg-red-600 transition flex items-center gap-2 transform hover:scale-105">
                <i data-lucide="x-circle" class="w-5 h-5"></i> Refuser
            </button>
            <button onclick="handleViewerAction('${userId}', true)" class="px-6 py-3 bg-green-500 text-white font-bold rounded-full shadow-lg hover:bg-green-600 transition flex items-center gap-2 transform hover:scale-105">
                <i data-lucide="check-circle-2" class="w-5 h-5"></i> Valider le dossier
            </button>
        </div>
    `;

            document.body.appendChild(m);
            lucide.createIcons();
        }

        // Fonction relais pour fermer la modale apr√®s action
        async function handleViewerAction(userId, isApproved) {
            // On ferme la visionneuse
            const modal = document.getElementById('doc-viewer-modal');
            if (modal) modal.remove();

            // On appelle ta fonction de validation existante
            // Note : validate() contient d√©j√† un confirm(), peut-√™tre redondant ici mais plus s√ªr.
            await validate(userId, isApproved);
        }

        async function loadAdmins() { const { data } = await supabase.from('profiles').select('first_name').eq('is_admin', true); state.admins = data; }
        async function loadTemplates() { const { data } = await supabase.from('event_templates').select('*'); state.templates = data; }
        async function loadTeams() { const { data } = await supabase.from('teams').select('*'); state.teams = data; }
        async function openShiftQR(id, t) { const m = document.createElement('div'); m.className = 'fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4'; m.innerHTML = `<div class="bg-white p-6 rounded-3xl text-center"><h3 class="font-bold mb-4">${t}</h3><div id="qr-c" class="border-4 border-brand-100 rounded-xl p-2 mb-4 mx-auto w-fit"></div><button onclick="this.closest('.fixed').remove()" class="bg-slate-100 px-6 py-2 rounded-xl font-bold">Fermer</button></div>`; document.body.appendChild(m); new QRCode(document.getElementById("qr-c"), { text: JSON.stringify({ shift_id: id, type: 'attendance_validation' }), width: 200, height: 200 }); }

        async function viewParticipants(shiftId, title) {
            toggleLoader(true);
            const { data: regs } = await supabase
                .from('registrations')
                .select('*, profiles(first_name, last_name, phone, status)')
                .eq('shift_id', shiftId);
            toggleLoader(false);

            const m = document.createElement('div');
            m.className = 'fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in';

            const listHtml = regs.map(r => `
                <div class="p-4 bg-white border border-slate-100 rounded-2xl flex justify-between items-center mb-2 shadow-sm">
                    <div>
                        <div class="font-bold text-slate-900">${r.profiles.first_name} ${r.profiles.last_name}</div>
                        <div class="text-xs text-slate-400">${r.profiles.phone || 'Pas de tel'}</div>
                    </div>
                    <div class="flex items-center gap-3">
                        <label class="flex items-center gap-2 cursor-pointer bg-slate-50 px-3 py-2 rounded-xl border border-slate-200">
                            <input type="checkbox" ${r.attended ? 'checked' : ''} onchange="toggleShiftPresence('${r.id}', this.checked)" class="w-4 h-4 text-green-600 rounded focus:ring-green-500">
                            <span class="text-xs font-bold text-slate-600">Pr√©sent</span>
                        </label>
                        <button onclick="forceUnsubscribe('${r.id}')" class="bg-red-50 text-red-500 p-2 rounded-xl hover:bg-red-100" title="D√©sinscrire">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            `).join('');

            m.innerHTML = `
                <div class="bg-slate-50 w-full max-w-lg rounded-3xl p-6 h-[80vh] flex flex-col shadow-2xl animate-slide-up relative">
                    <button onclick="this.closest('.fixed').remove()" class="absolute top-5 right-5 bg-white p-2 rounded-full shadow-sm hover:bg-slate-100 transition">
                        <i data-lucide="x" class="w-4 h-4 text-slate-500"></i>
                    </button>
                    
                    <h3 class="text-xl font-extrabold text-slate-900 mb-1">${title}</h3>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wide mb-6">${regs.length} inscrit(s)</p>
                    
                    <div class="flex-1 overflow-y-auto no-scrollbar space-y-2">
                        ${listHtml || '<div class="text-center py-10 text-slate-400">Aucun inscrit pour le moment.</div>'}
                    </div>
                </div>
            `;
            document.body.appendChild(m);
            lucide.createIcons();
        }

        async function viewPoleCandidates(teamId, teamName) {
            // S√âCURIT√â : Admin seulement
            if (!state.profile?.is_admin) return;

            toggleLoader(true);

            // On r√©cup√®re les int√©r√™ts avec les infos des profils li√©s
            const { data: candidates, error } = await supabase
                .from('pole_interests')
                .select('created_at, profiles(id, first_name, last_name, phone, email, status)')
                .eq('team_id', teamId)
                .order('created_at', { ascending: false });

            toggleLoader(false);

            if (error) {
                console.error(error);
                return showToast("Erreur r√©cup√©ration candidats", "error");
            }

            const m = document.createElement('div');
            m.className = 'fixed inset-0 bg-black/60 z-[70] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in';

            const listHtml = candidates.length > 0 ? candidates.map(c => {
                const p = c.profiles;
                const date = new Date(c.created_at).toLocaleDateString('fr-FR');

                return `
        <div class="bg-white p-4 rounded-2xl border border-slate-100 flex items-center justify-between mb-3 shadow-sm hover:shadow-md transition">
            <div onclick="viewUserDetails('${p.id}')" class="cursor-pointer flex-1">
                <div class="flex items-center gap-2">
                    <div class="font-bold text-slate-900">${p.first_name} ${p.last_name}</div>
                    ${p.status === 'pending' ? '<span class="w-2 h-2 bg-orange-400 rounded-full" title="En attente validation"></span>' : ''}
                </div>
                <div class="text-xs text-slate-500 flex gap-3 mt-1">
                    <span><i data-lucide="calendar" class="w-3 h-3 inline"></i> ${date}</span>
                    <span><i data-lucide="phone" class="w-3 h-3 inline"></i> ${p.phone || '-'}</span>
                </div>
            </div>
            
            <button onclick="viewUserDetails('${p.id}')" class="bg-slate-50 text-brand-600 p-2 rounded-xl hover:bg-brand-50 transition border border-slate-200">
                <i data-lucide="user" class="w-4 h-4"></i>
            </button>
        </div>`;
            }).join('') : `<div class="text-center py-10 text-slate-400 italic flex flex-col items-center"><i data-lucide="inbox" class="w-10 h-10 mb-2 opacity-50"></i>Aucun candidat pour le moment.</div>`;

            m.innerHTML = `
        <div class="bg-slate-50 w-full max-w-md rounded-[2rem] p-6 h-[70vh] flex flex-col shadow-2xl animate-slide-up relative">
            <button onclick="this.closest('.fixed').remove()" class="absolute top-5 right-5 bg-white p-2 rounded-full shadow-sm hover:bg-slate-100 transition text-slate-500">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
            
            <div class="mb-6">
                <div class="text-xs font-bold text-brand-600 uppercase tracking-wider mb-1">Recrutement</div>
                <h3 class="text-xl font-extrabold text-slate-900">Int√©ress√©s par : ${teamName}</h3>
                <p class="text-sm text-slate-500 mt-1">${candidates.length} b√©n√©vole(s) ont lev√© la main.</p>
            </div>
            
            <div class="flex-1 overflow-y-auto no-scrollbar space-y-1 pr-1">
                ${listHtml}
            </div>
        </div>
    `;

            document.body.appendChild(m);
            lucide.createIcons();
        }

        async function toggleShiftPresence(regId, isPresent) {
            await supabase.from('registrations').update({ attended: isPresent }).eq('id', regId);
            showToast(isPresent ? 'Pr√©sence valid√©e' : 'Pr√©sence annul√©e');
        }

        async function forceUnsubscribe(regId) {
            if (!confirm('√ätes-vous s√ªr de vouloir d√©sinscrire ce b√©n√©vole ?')) return;
            await supabase.from('registrations').delete().eq('id', regId);
            document.querySelector('.fixed.z-50').remove(); // Ferme la modale
            showToast('B√©n√©vole d√©sinscrit');
            renderPlanningAdmin(document.getElementById('main-slot')); // Rafra√Æchit
        }

        // ============================================================
        // SYSTEME DE MESSAGERIE & TICKETS (SUPPORT)
        // ============================================================

        let currentTicketId = null;
        let realtimeChannel = null;

        async function renderMessages(c) {
            const isViewAdmin = state.profile.is_admin && state.adminMode;

            let query = supabase
                .from('tickets')
                .select('*, profiles(first_name, last_name)')
                .order('last_message_at', { ascending: false });

            if (!isViewAdmin) {
                query = query.or(`user_id.eq.${state.user.id},category.eq.announcement`);
            }

            const { data: tickets, error } = await query;
            if (currentTicketId && tickets) {
                const exists = tickets.find(t => t.id === currentTicketId);
                if (!exists) currentTicketId = null;
            }

            c.innerHTML = `
        <div class="flex flex-col md:flex-row h-[calc(100dvh-160px)] md:h-[calc(100vh-140px)] bg-white border border-slate-100 rounded-3xl overflow-hidden shadow-sm relative animate-fade-in">
            
            <div id="ticket-list" class="${currentTicketId ? 'hidden md:flex' : 'flex'} w-full md:w-80 flex-col border-r border-slate-100 bg-slate-50 h-full">
                
                <div class="p-4 border-b border-slate-200/50 flex justify-between items-center bg-white sticky top-0 z-10 flex-shrink-0">
                    <h2 class="font-extrabold text-slate-800">Discussions</h2>
                    ${isViewAdmin
                    ? `<div class="flex gap-2">
                            <button onclick="openNewConversationModal()" class="bg-brand-600 text-white p-2 rounded-xl shadow-md hover:bg-brand-700 transition"><i data-lucide="message-square-plus" class="w-4 h-4"></i></button>
                            <button onclick="openAnnouncementModal()" class="bg-purple-600 text-white p-2 rounded-xl shadow-md hover:bg-purple-700 transition"><i data-lucide="megaphone" class="w-4 h-4"></i></button>
                           </div>`
                    : `<button onclick="openNewTicketModal()" class="bg-brand-600 text-white p-2 rounded-xl shadow-md hover:bg-brand-700 transition"><i data-lucide="plus" class="w-4 h-4"></i></button>`
                }
                </div>

                <div class="flex-1 overflow-y-auto p-2 space-y-2">
                    ${tickets && tickets.length > 0
                    ? tickets.map(t => renderTicketItem(t, isViewAdmin)).join('')
                    : `<div class="flex flex-col items-center justify-center h-40 text-slate-400 text-xs text-center"><i data-lucide="inbox" class="w-8 h-8 mb-2 opacity-50"></i>Aucune discussion.</div>`
                }
                </div>
            </div>

            <div class="${currentTicketId ? 'flex' : 'hidden md:flex'} flex-1 flex-col bg-white relative h-full min-w-0">
                
                ${currentTicketId ? `
                    <div id="chat-header" class="px-4 py-3 border-b border-slate-100 flex items-center gap-3 shadow-sm z-10 bg-white/90 backdrop-blur flex-shrink-0 min-h-[60px]">
                        <button onclick="closeTicket()" class="md:hidden -ml-2 p-2 text-slate-500 hover:bg-slate-50 rounded-full active:scale-95 transition flex-shrink-0">
                            <i data-lucide="arrow-left" class="w-6 h-6"></i>
                        </button>
                        
                        <div class="flex-1 min-w-0">
                            <div id="chat-subject" class="font-bold text-slate-900 text-sm md:text-base break-words whitespace-normal leading-tight">
                                Chargement...
                            </div>
                            <div id="chat-meta" class="text-xs text-slate-500 truncate mt-0.5">...</div>
                        </div>
                    </div>

                    <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50/30 scroll-smooth w-full">
                        <div class="flex justify-center pt-10"><div class="animate-spin w-6 h-6 border-2 border-brand-500 rounded-full border-t-transparent"></div></div>
                    </div>

                    <div id="chat-input-area" class="p-3 border-t border-slate-100 bg-white flex-shrink-0 pb-safe">
                        <form onsubmit="sendTicketMessage(event)" class="flex gap-2 w-full max-w-4xl mx-auto items-end">
                            <input id="ticket-msg-in" autocomplete="off" class="flex-1 p-3 bg-slate-50 rounded-2xl font-bold text-sm outline-none focus:ring-2 focus:ring-brand-500 transition min-w-0" placeholder="√âcrire un message...">
                            <button type="submit" class="bg-brand-600 text-white w-12 h-12 rounded-2xl flex items-center justify-center shadow-lg shadow-brand-200 active:scale-95 transition flex-shrink-0">
                                <i data-lucide="send" class="w-5 h-5 ml-0.5"></i>
                            </button>
                        </form>
                    </div>
                ` : `
                    <div class="flex-1 flex flex-col items-center justify-center text-slate-300 hidden md:flex">
                        <div class="w-20 h-20 bg-slate-50 rounded-full flex items-center justify-center mb-4">
                            <i data-lucide="message-square" class="w-8 h-8 opacity-50"></i>
                        </div>
                        <p class="font-bold text-sm">S√©lectionnez une conversation</p>
                    </div>
                `}
            </div>
        </div>
    `;

            if (currentTicketId) loadTicketMessages(currentTicketId);
            lucide.createIcons();
        }

        // --- RENDU ITEM LISTE (GAUCHE) ---
        function renderTicketItem(t, isViewAdmin) {
            const isAnnounce = t.category === 'announcement';
            const active = currentTicketId === t.id ? 'bg-white border-brand-200 shadow-md ring-1 ring-brand-100' : 'hover:bg-white hover:shadow-sm border-transparent';

            // Titre intelligent :
            // Si Admin : On affiche le NOM du b√©n√©vole.
            // Si B√©n√©vole (ou Annonce) : On affiche le SUJET.
            let title = t.subject;
            let subtitle = new Date(t.last_message_at).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });

            if (isViewAdmin && !isAnnounce) {
                title = `${t.profiles?.first_name || 'Inconnu'} ${t.profiles?.last_name || ''}`;
                subtitle = t.subject;
            }

            return `
        <button onclick="openTicket(${t.id})" class="w-full text-left p-3 rounded-2xl border transition-all duration-200 group ${active}">
            <div class="flex justify-between items-start mb-1">
                <span class="font-bold text-sm text-slate-800 line-clamp-1 ${isAnnounce ? 'text-purple-600' : ''}">
                    ${isAnnounce ? '<i data-lucide="megaphone" class="w-3 h-3 inline mr-1"></i>' : ''} ${title}
                </span>
                ${isAnnounce ? '<span class="bg-purple-100 text-purple-600 text-[9px] px-1.5 py-0.5 rounded font-bold uppercase">Info</span>' : ''}
            </div>
            <div class="flex justify-between items-center text-xs text-slate-400 group-hover:text-slate-500">
                <span class="line-clamp-1 mr-2">${subtitle}</span>
                <i data-lucide="chevron-right" class="w-3 h-3 opacity-0 group-hover:opacity-100 transition"></i>
            </div>
        </button>
    `;
        }

        function openTicket(id) { currentTicketId = id; renderMessages(document.getElementById('main-slot')); }
        function closeTicket() { currentTicketId = null; renderMessages(document.getElementById('main-slot')); }

        // --- CHARGEMENT DES MESSAGES D'UN TICKET ---
        async function loadTicketMessages(ticketId) {
            // 1. Infos du Ticket (Header)
            const { data: ticket } = await supabase.from('tickets').select('*, profiles(*)').eq('id', ticketId).single();

            if (ticket) {
                const sub = document.getElementById('chat-subject');
                const meta = document.getElementById('chat-meta');

                if (sub) sub.innerText = ticket.subject;
                if (meta) meta.innerText = ticket.category === 'announcement'
                    ? 'üì¢ Annonce G√©n√©rale'
                    : `Conversation avec ${ticket.profiles?.first_name} ${ticket.profiles?.last_name}`;

                // Si c'est une annonce et que je suis en Vue B√©n√©vole -> Masquer zone de saisie
                const isViewAdmin = state.profile.is_admin && state.adminMode;
                const inputArea = document.getElementById('chat-input-area');

                if (ticket.category === 'announcement' && !isViewAdmin) {
                    if (inputArea) inputArea.style.display = 'none';
                } else {
                    if (inputArea) inputArea.style.display = 'block';
                }
            }

            // 2. Les Messages
            const { data: msgs } = await supabase
                .from('messages')
                .select('*, profiles(id, first_name, last_name, role_title, is_admin)')
                .eq('ticket_id', ticketId)
                .order('created_at', { ascending: true });

            const container = document.getElementById('chat-messages');
            if (container) {
                container.innerHTML = msgs.map(m => renderTicketBubble(m)).join('');
                container.scrollTop = container.scrollHeight;
            }

            // 3. Connexion Realtime
            initTicketRealtime(ticketId);
        }

        // --- REALTIME (Mise √† jour en direct) ---
        function initTicketRealtime(ticketId) {
            if (realtimeChannel) supabase.removeChannel(realtimeChannel);

            realtimeChannel = supabase
                .channel(`ticket:${ticketId}`)
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'messages',
                    filter: `ticket_id=eq.${ticketId}`
                }, (payload) => {
                    // On recharge les messages quand un nouveau arrive
                    loadTicketMessages(ticketId);
                })
                .subscribe();
        }

        function renderTicketBubble(m) {
            const isMe = m.user_id === state.user.id;
            const p = m.profiles || {};

            // Badge Responsable
            let badge = '';
            if (p.is_admin && !isMe) {
                badge = `<span class="ml-2 bg-yellow-100 text-yellow-800 text-[9px] px-1.5 py-0.5 rounded border border-yellow-200 font-bold uppercase tracking-wider shadow-sm flex-shrink-0">STAFF</span>`;
            }

            // CORRECTION ICI : Ajout de "break-words" et "min-w-0" pour emp√™cher le d√©bordement horizontal
            return `
        <div class="flex flex-col ${isMe ? 'items-end' : 'items-start'} animate-fade-in mb-4 w-full">
            <div class="max-w-[85%] sm:max-w-[75%] min-w-0">
                ${!isMe ? `<div class="text-[10px] text-slate-400 mb-1 ml-1 flex items-center flex-wrap">${p.first_name || 'Utilisateur'} ${badge}</div>` : ''}
                
                <div class="px-4 py-3 rounded-2xl text-sm shadow-sm break-words whitespace-normal ${isMe
                    ? 'bg-brand-600 text-white rounded-tr-none shadow-brand-100'
                    : (p.is_admin ? 'bg-white border border-yellow-200 ring-2 ring-yellow-50/50 text-slate-800 rounded-tl-none' : 'bg-white border border-slate-100 text-slate-800 rounded-tl-none')
                }">
                    ${escapeHtml(m.content).replace(/\n/g, '<br>')}
                </div>
                
                <div class="text-[9px] text-slate-300 mt-1 px-1 ${isMe ? 'text-right' : 'text-left'}">
                    ${new Date(m.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                </div>
            </div>
        </div>
    `;
        }

        // --- ENVOI DE MESSAGE ---
        async function sendTicketMessage(e) {
            e.preventDefault();
            const input = document.getElementById('ticket-msg-in');
            const txt = input.value.trim();
            if (!txt || !currentTicketId) return;

            input.value = ''; // UI Optimiste

            const { error } = await supabase.from('messages').insert([{
                ticket_id: currentTicketId,
                user_id: state.user.id,
                content: txt
            }]);

            if (error) {
                showToast("Erreur d'envoi", "error");
                input.value = txt; // En cas d'erreur on remet le texte
            } else {
                // Met √† jour le ticket pour qu'il remonte dans la liste
                await supabase.from('tickets').update({ last_message_at: new Date() }).eq('id', currentTicketId);
            }
        }

        // --- MODALE NOUVEAU TICKET (Pour B√©n√©voles) ---
        function openNewTicketModal() {
            const m = document.createElement('div');
            m.className = 'fixed inset-0 bg-black/60 z-[80] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in';
            m.innerHTML = `
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-slide-up">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-extrabold text-lg text-slate-900">Nouvelle Demande</h3>
                <button onclick="this.closest('.fixed').remove()" class="bg-slate-50 p-2 rounded-full text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
            
            <form onsubmit="handleCreateTicket(event)" class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Sujet</label>
                    <input name="subject" required class="w-full p-3 bg-slate-50 rounded-xl font-bold text-sm outline-none focus:ring-2 focus:ring-brand-500" placeholder="Ex: Retard, Justificatif...">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Message</label>
                    <textarea name="content" rows="4" required class="w-full p-3 bg-slate-50 rounded-xl font-bold text-sm outline-none focus:ring-2 focus:ring-brand-500" placeholder="Votre message..."></textarea>
                </div>
                <button type="submit" class="w-full py-3.5 bg-brand-600 text-white font-bold rounded-xl shadow-lg hover:bg-brand-700 transition">Envoyer</button>
            </form>
        </div>
    `;
            document.body.appendChild(m);
            lucide.createIcons();
        }

        async function handleCreateTicket(e) {
            e.preventDefault();
            const fd = new FormData(e.target);
            const subject = fd.get('subject').trim();
            const content = fd.get('content').trim();

            if (!subject || !content) return showToast("Champs requis", "error");

            toggleLoader(true);

            // 1. Cr√©er le ticket
            const { data: ticket, error: tErr } = await supabase
                .from('tickets')
                .insert([{ user_id: state.user.id, subject, category: 'support' }])
                .select()
                .single();

            if (ticket) {
                // 2. Cr√©er le premier message
                await supabase.from('messages').insert([{ ticket_id: ticket.id, user_id: state.user.id, content }]);
                document.querySelector('.fixed.z-\\[80\\]').remove();
                showToast("Demande envoy√©e !");

                await renderMessages(document.getElementById('main-slot'));
                openTicket(ticket.id);
            } else {
                showToast("Erreur cr√©ation", "error");
            }
            toggleLoader(false);
        }

        // --- MODALE ANNONCE (Pour Admins) ---
        function openAnnouncementModal() {
            const m = document.createElement('div');
            m.className = 'fixed inset-0 bg-black/60 z-[80] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in';
            m.innerHTML = `
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-slide-up border-t-4 border-purple-500">
            <h3 class="font-extrabold text-lg mb-4 text-purple-900">üì¢ Faire une annonce</h3>
            <p class="text-xs text-slate-500 mb-4">Ce message sera visible par TOUS les b√©n√©voles.</p>
            <form onsubmit="handleCreateAnnouncement(event)" class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Titre</label>
                    <input name="subject" required class="w-full p-3 bg-purple-50 rounded-xl font-bold text-sm outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Message</label>
                    <textarea name="content" rows="4" required class="w-full p-3 bg-purple-50 rounded-xl font-bold text-sm outline-none focus:ring-2 focus:ring-purple-500"></textarea>
                </div>
                <button type="submit" class="w-full py-3 bg-purple-600 text-white font-bold rounded-xl shadow-lg hover:bg-purple-700">Publier l'annonce</button>
                <button type="button" onclick="this.closest('.fixed').remove()" class="w-full py-3 text-slate-400 font-bold text-sm">Annuler</button>
            </form>
        </div>
    `;
            document.body.appendChild(m);
        }

        async function handleCreateAnnouncement(e) {
            e.preventDefault();
            const fd = new FormData(e.target);
            toggleLoader(true);

            const { data: ticket } = await supabase
                .from('tickets')
                .insert([{ user_id: state.user.id, subject: fd.get('subject'), category: 'announcement' }])
                .select().single();

            if (ticket) {
                await supabase.from('messages').insert([{ ticket_id: ticket.id, user_id: state.user.id, content: fd.get('content') }]);
                document.querySelector('.fixed.z-\\[80\\]').remove();
                showToast('Annonce publi√©e !');
                renderMessages(document.getElementById('main-slot'));
            }
            toggleLoader(false);
        }


        // ============================================================
        // SYSTEME DE P√îLES & √âQUIPES
        // ============================================================

        async function renderPoles(c) {
            // 1. R√©cup√©ration des responsables
            const { data: leaders } = await supabase
                .from('profiles')
                .select('first_name, last_name, role_title, pole_id')
                .not('pole_id', 'is', null)
                .not('role_title', 'is', null);

            // V√©rification Vue Admin (pour afficher les boutons d'√©dition)
            const isViewAdmin = state.profile.is_admin && state.adminMode;

            const html = state.teams.map(t => {
                const intr = state.myInterests.includes(t.id);
                const teamLeaders = leaders ? leaders.filter(l => l.pole_id === t.id) : [];

                // --- BOUTONS ADMINS ---
                const adminActions = isViewAdmin ? `
            <div class="absolute top-4 right-4 flex gap-2 z-10 bg-white/90 backdrop-blur-sm p-1.5 rounded-xl shadow-sm border border-slate-100">
                <button onclick="viewPoleCandidates('${t.id}', '${t.name.replace(/'/g, "\\'")}')" class="p-2 rounded-lg text-slate-500 hover:text-blue-600 hover:bg-blue-50 transition relative group" title="Voir les int√©ress√©s">
                    <i data-lucide="list-filter" class="w-4 h-4"></i>
                    <span class="absolute -top-1 -right-1 w-2 h-2 bg-blue-500 rounded-full animate-pulse"></span>
                </button>
                <div class="w-px h-6 bg-slate-200 mx-1"></div>
                <button onclick="openEditPoleModal('${t.id}')" class="p-2 rounded-lg text-slate-400 hover:text-brand-600 hover:bg-brand-50 transition" title="Modifier">
                    <i data-lucide="pencil" class="w-4 h-4"></i>
                </button>
                <button onclick="deletePole('${t.id}')" class="p-2 rounded-lg text-slate-400 hover:text-red-600 hover:bg-red-50 transition" title="Supprimer">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
            </div>
        ` : '';

                return `
        <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 mb-4 animate-fade-in relative overflow-hidden group hover:shadow-md transition-all">
            
            ${adminActions}

            <div class="flex justify-between items-start mb-4 pr-24"> 
                <div class="flex items-center gap-3">
                    <div class="w-14 h-14 bg-brand-50 text-brand-600 rounded-2xl flex items-center justify-center shadow-inner">
                        <i data-lucide="${t.icon || 'users'}" class="w-7 h-7"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg text-slate-900 leading-tight">${t.name}</h3>
                        <p class="text-xs text-slate-400 font-medium">${teamLeaders.length} responsable(s)</p>
                    </div>
                </div>
            </div>

            <p class="text-sm text-slate-600 mb-5 bg-slate-50 p-4 rounded-xl leading-relaxed">
                ${t.description || 'Aucune description pour ce p√¥le.'}
            </p>

            ${teamLeaders.length > 0 ? `
                <div class="space-y-2 mb-5">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Responsables</p>
                    <div class="flex flex-wrap gap-2">
                        ${teamLeaders.map(l => `
                            <div class="flex items-center gap-2 bg-white border border-slate-200 px-3 py-1.5 rounded-full shadow-sm">
                                <div class="w-5 h-5 bg-gradient-to-br from-brand-400 to-brand-600 text-white rounded-full flex items-center justify-center text-[9px] font-bold">
                                    ${l.first_name[0]}
                                </div>
                                <div class="text-xs">
                                    <span class="font-bold text-slate-800">${l.first_name}</span>
                                    <span class="text-slate-500 hidden sm:inline">‚Ä¢ ${l.role_title}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : '<div class="mb-5 text-xs text-slate-300 italic flex items-center gap-1"><i data-lucide="info" class="w-3 h-3"></i> Aucun responsable assign√©.</div>'}

            <button onclick="toggleInterest(${t.id})" class="w-full py-3.5 rounded-xl text-xs font-bold transition flex items-center justify-center gap-2 ${intr ? 'bg-green-100 text-green-700 border border-green-200' : 'bg-slate-900 text-white shadow-lg hover:bg-slate-800 active:scale-95'}">
                ${intr ? '<i data-lucide="check" class="w-4 h-4"></i> Int√©ress√©(e)' : 'Rejoindre ce p√¥le'}
            </button>
        </div>`;
            }).join('');

            const createBtn = isViewAdmin
                ? `<button onclick="openCreatePoleModal()" class="bg-brand-600 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-lg shadow-brand-200 hover:scale-110 transition"><i data-lucide="plus" class="w-5 h-5"></i></button>`
                : '';

            c.innerHTML = `
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-2xl font-extrabold text-slate-900">P√¥les & √âquipes</h2>
                <p class="text-slate-500 text-sm">D√©couvrez les diff√©rents r√¥les.</p>
            </div>
            ${createBtn}
        </div>
        <div class="pb-24 grid md:grid-cols-2 gap-4">
            ${html || '<div class="col-span-2 text-center py-20 text-slate-400">Aucun p√¥le actif.</div>'}
        </div>
    `;
            lucide.createIcons();
        }

        async function toggleInterest(tid) {
            toggleLoader(true);
            try {
                if (state.myInterests.includes(tid)) {
                    // D√©sinscription
                    await supabase.from('pole_interests').delete().eq('user_id', state.user.id).eq('team_id', tid);
                    state.myInterests = state.myInterests.filter(i => i !== tid);
                    showToast('Int√©r√™t retir√©');
                } else {
                    // Inscription
                    await supabase.from('pole_interests').insert([{ user_id: state.user.id, team_id: tid }]);
                    state.myInterests.push(tid);
                    showToast('Int√©r√™t signal√© aux admins !');
                }
                // On recharge juste la vue pour mettre √† jour les boutons
                renderPoles(document.getElementById('main-slot'));
            } catch (e) {
                showToast('Erreur connexion', 'error');
            } finally {
                toggleLoader(false);
            }
        }

        // ============================================================
        // MODIFICATION UX : CR√âATION DE P√îLE (Modale)
        // ============================================================

        function openCreatePoleModal() {
            const m = document.createElement('div');
            m.id = 'create-pole-modal';
            m.className = 'fixed inset-0 bg-black/60 z-[70] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in';

            m.innerHTML = `
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-slide-up">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-extrabold text-xl text-slate-900">Nouveau P√¥le</h3>
                <button onclick="document.getElementById('create-pole-modal').remove()" class="bg-slate-50 p-2 rounded-full text-slate-400 hover:text-slate-600 transition">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <form onsubmit="handleCreatePole(event)" class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Nom du p√¥le</label>
                    <input name="name" placeholder="Ex: Logistique" class="w-full p-3 bg-slate-50 rounded-xl font-bold border-none outline-none focus:ring-2 focus:ring-brand-500 transition" required>
                </div>
                
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Description courte</label>
                    <textarea name="desc" rows="2" placeholder="G√®re le stock et les livraisons..." class="w-full p-3 bg-slate-50 rounded-xl font-bold border-none outline-none focus:ring-2 focus:ring-brand-500 transition"></textarea>
                </div>

                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase ml-1 mb-1 block">Ic√¥ne (Lucide.dev)</label>
                    <div class="flex gap-2">
                        <input id="icon-input" name="icon" value="users" oninput="previewIcon(this.value)" class="flex-1 p-3 bg-slate-50 rounded-xl font-bold border-none outline-none focus:ring-2 focus:ring-brand-500 transition">
                        <div class="w-12 h-12 bg-brand-100 text-brand-600 rounded-xl flex items-center justify-center transition-all duration-300" id="icon-preview">
                            <i data-lucide="users" class="w-6 h-6"></i>
                        </div>
                    </div>
                    <p class="text-[10px] text-slate-400 mt-1 pl-1">Tapez un nom : heart, truck, apple, zap...</p>
                </div>

                <button type="submit" class="w-full py-3.5 bg-brand-600 text-white font-bold rounded-xl shadow-lg hover:bg-brand-700 transition mt-2">Cr√©er le p√¥le</button>
            </form>
        </div>
    `;
            document.body.appendChild(m);
            lucide.createIcons();
        }

        function previewIcon(name) {
            const container = document.getElementById('icon-preview');
            container.innerHTML = `<i data-lucide="${name}" class="w-6 h-6"></i>`;
            lucide.createIcons();
            // Petit feedback visuel si l'ic√¥ne n'existe pas (Lucide laisse vide ou met un d√©faut)
        }

        async function handleCreatePole(e) {
            e.preventDefault();
            const fd = new FormData(e.target);
            const name = fd.get('name').trim();
            const desc = fd.get('desc').trim();
            const icon = fd.get('icon').trim() || 'users';

            if (!name) return showToast("Le nom est obligatoire", "error");

            toggleLoader(true);

            const { error } = await supabase.from('teams').insert([{ name, description: desc, icon }]);

            if (error) {
                console.error(error);
                showToast("Erreur cr√©ation", "error");
            } else {
                showToast('P√¥le cr√©√© avec succ√®s !');
                document.getElementById('create-pole-modal').remove();
                await loadTeams();
                renderPoles(document.getElementById('main-slot'));
            }
            toggleLoader(false);
        }


        async function deletePole(id) {
            if (!confirm("‚ö†Ô∏è Attention : Supprimer ce p√¥le est irr√©versible.\nLes responsables perdront leur affectation.\n\nContinuer ?")) return;

            toggleLoader(true);
            const { error } = await supabase.from('teams').delete().eq('id', id);

            if (error) {
                showToast("Impossible de supprimer (utilis√© ailleurs ?)", "error");
                console.error(error);
            } else {
                showToast('P√¥le supprim√© avec succ√®s');
                // Mise √† jour locale pour √©viter le rechargement total
                state.teams = state.teams.filter(t => t.id != id);
                renderPoles(document.getElementById('main-slot'));
            }
            toggleLoader(false);
        }

        function openEditPoleModal(id) {
            // On trouve le p√¥le dans les donn√©es locales
            const t = state.teams.find(x => x.id == id);
            if (!t) return;

            const m = document.createElement('div');
            m.id = 'edit-pole-modal';
            m.className = 'fixed inset-0 bg-black/60 z-[70] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in';

            m.innerHTML = `
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-slide-up">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-extrabold text-xl text-slate-900">Modifier le P√¥le</h3>
                <button onclick="document.getElementById('edit-pole-modal').remove()" class="bg-slate-50 p-2 rounded-full text-slate-400 hover:text-slate-600 transition">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <form onsubmit="handleUpdatePole(event, '${id}')" class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Nom du p√¥le</label>
                    <input name="name" value="${t.name}" class="w-full p-3 bg-slate-50 rounded-xl font-bold border-none outline-none focus:ring-2 focus:ring-brand-500 transition" required>
                </div>
                
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Description</label>
                    <textarea name="desc" rows="3" class="w-full p-3 bg-slate-50 rounded-xl font-bold border-none outline-none focus:ring-2 focus:ring-brand-500 transition">${t.description || ''}</textarea>
                </div>

                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase ml-1 mb-1 block">Ic√¥ne (Lucide)</label>
                    <div class="flex gap-2">
                        <input id="edit-icon-input" name="icon" value="${t.icon || 'users'}" oninput="document.getElementById('edit-icon-preview').innerHTML = '<i data-lucide=\''+this.value+'\'></i>'; lucide.createIcons();" class="flex-1 p-3 bg-slate-50 rounded-xl font-bold border-none outline-none focus:ring-2 focus:ring-brand-500 transition">
                        <div class="w-12 h-12 bg-slate-100 text-slate-600 rounded-xl flex items-center justify-center" id="edit-icon-preview">
                            <i data-lucide="${t.icon || 'users'}" class="w-6 h-6"></i>
                        </div>
                    </div>
                </div>

                <button type="submit" class="w-full py-3.5 bg-slate-900 text-white font-bold rounded-xl shadow-lg hover:bg-slate-800 transition mt-2">Enregistrer</button>
            </form>
        </div>
    `;
            document.body.appendChild(m);
            lucide.createIcons();
        }

        async function handleUpdatePole(e, id) {
            e.preventDefault();
            const fd = new FormData(e.target);
            const name = fd.get('name').trim();
            const desc = fd.get('desc').trim();
            const icon = fd.get('icon').trim();

            toggleLoader(true);

            const { error } = await supabase
                .from('teams')
                .update({ name, description: desc, icon })
                .eq('id', id);

            if (error) {
                console.error(error);
                showToast("Erreur lors de la modification", "error");
            } else {
                showToast('P√¥le mis √† jour !');
                document.getElementById('edit-pole-modal').remove();

                // Mise √† jour des donn√©es locales
                await loadTeams();
                renderPoles(document.getElementById('main-slot'));
            }
            toggleLoader(false);
        }

        async function savePoleEdit(id, btn) {
            const name = document.getElementById('edit-pole-name').value;
            const desc = document.getElementById('edit-pole-desc').value;
            const icon = document.getElementById('edit-pole-icon').value;

            btn.innerText = "...";
            await supabase.from('teams').update({ name, description: desc, icon }).eq('id', id);

            document.querySelector('.fixed.z-\\[60\\]').remove();
            showToast('P√¥le modifi√© !');
            await loadTeams();
            renderPoles(document.getElementById('main-slot'));
        }
        // START
        window.onload = initApp;

        // ============================================================
        // MODIFICATION PROFIL
        // ============================================================
        function openEditProfileModal() {
            const p = state.profile;
            const m = document.createElement('div');
            m.id = 'edit-profile-modal';
            m.className = 'fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in';

            m.innerHTML = `
                <div class="bg-white w-full max-w-md rounded-3xl p-6 relative shadow-2xl animate-slide-up">
                    <button onclick="document.getElementById('edit-profile-modal').remove()" class="absolute top-4 right-4 bg-slate-100 p-2 rounded-full hover:bg-slate-200 transition">
                        <i data-lucide="x" class="w-4 h-4 text-slate-500"></i>
                    </button>
                    
                    <h3 class="text-xl font-extrabold text-slate-900 mb-6">Modifier mon profil</h3>
                    
                    <form onsubmit="handleUpdateProfile(event)" class="space-y-4">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs font-bold text-slate-400 uppercase ml-1">Pr√©nom</label>
                                <input name="first_name" value="${p.first_name}" required class="w-full p-3 bg-slate-50 rounded-xl font-bold outline-none focus:ring-2 focus:ring-brand-500">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-400 uppercase ml-1">Nom</label>
                                <input name="last_name" value="${p.last_name}" required class="w-full p-3 bg-slate-50 rounded-xl font-bold outline-none focus:ring-2 focus:ring-brand-500">
                            </div>
                        </div>

                        <div>
                            <label class="text-xs font-bold text-slate-400 uppercase ml-1">T√©l√©phone</label>
                            <input name="phone" type="tel" value="${p.phone || ''}" class="w-full p-3 bg-slate-50 rounded-xl font-bold outline-none focus:ring-2 focus:ring-brand-500">
                        </div>

                        <div class="p-4 bg-orange-50 rounded-xl border border-orange-100">
                            <label class="flex items-center gap-3 cursor-pointer">
                                <input type="checkbox" name="mandatory" ${p.mandatory_hours ? 'checked' : ''} class="w-5 h-5 text-orange-500 rounded focus:ring-orange-500">
                                <div>
                                    <span class="text-sm font-bold text-orange-900 block">Heures Obligatoires</span>
                                    <span class="text-[10px] text-orange-700">Cochez si vous devez valider un stage.</span>
                                </div>
                            </label>
                        </div>

                        <div class="pt-4 border-t border-slate-100">
                            <label class="text-xs font-bold text-slate-400 uppercase ml-1 mb-1 block">Nouveau mot de passe (optionnel)</label>
                            <input name="password" type="password" placeholder="Laisser vide pour ne pas changer" class="w-full p-3 bg-slate-50 rounded-xl font-bold outline-none focus:ring-2 focus:ring-brand-500">
                        </div>

                        <button type="submit" class="w-full py-4 bg-brand-600 text-white font-bold rounded-2xl shadow-lg hover:bg-brand-700 transition mt-2">Enregistrer les modifications</button>
                    </form>
                </div>
            `;

            document.body.appendChild(m);
            lucide.createIcons();
        }

        async function handleUpdateProfile(e) {
            e.preventDefault();
            toggleLoader(true);

            const formData = new FormData(e.target);
            const updates = {
                first_name: formData.get('first_name'),
                last_name: formData.get('last_name'),
                phone: formData.get('phone'),
                mandatory_hours: formData.get('mandatory') === 'on'
            };

            const newPass = formData.get('password');

            try {
                // 1. Mise √† jour des infos publiques (Table profiles)
                const { error: profileError } = await supabase
                    .from('profiles')
                    .update(updates)
                    .eq('id', state.user.id);

                if (profileError) throw profileError;

                // 2. Mise √† jour du mot de passe (Auth Supabase) si renseign√©
                if (newPass && newPass.trim() !== "") {
                    const { error: authError } = await supabase.auth.updateUser({ password: newPass });
                    if (authError) throw authError;
                }

                showToast('Profil mis √† jour avec succ√®s !');
                document.getElementById('edit-profile-modal').remove();
                await loadUserProfile(); // Recharge les donn√©es pour mettre √† jour l'affichage

            } catch (error) {
                console.error(error);
                showToast(error.message || 'Erreur lors de la mise √† jour', 'error');
            } finally {
                toggleLoader(false);
            }
        }

        // ============================================================
        // HISTORIQUE DES MISSIONS
        // ============================================================
        async function viewUserHistory(uid) {
            toggleLoader(true);

            const { data, error } = await supabase
                .from('registrations')
                .select(`
            id, attended,
            shifts (
                title, start_time, end_time,
                events ( title, date, location )
            )
        `)
                .eq('user_id', uid);

            toggleLoader(false);

            if (error) return showToast('Erreur r√©cup√©ration historique', 'error');

            // Tri s√©curis√©
            const history = data
                .filter(r => r.shifts && r.shifts.events)
                .sort((a, b) => new Date(b.shifts.events.date) - new Date(a.shifts.events.date));

            // Cr√©ation de la modale
            const m = document.createElement('div');
            m.className = 'fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in';

            const listHtml = history.length > 0 ? history.map(r => {
                const dateObj = new Date(r.shifts.events.date);
                const dateStr = dateObj.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', year: 'numeric' });

                return `
        <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100 flex items-center justify-between mb-3 group">
            <div>
                <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wide mb-1">${dateStr}</div>
                <div class="font-bold text-slate-900 text-sm">${r.shifts.events.title}</div>
                <div class="text-xs text-slate-500 mt-0.5">
                    ${r.shifts.title} ‚Ä¢ ${r.shifts.start_time.slice(0, 5)} - ${r.shifts.end_time.slice(0, 5)}
                </div>
            </div>
            <div class="flex items-center gap-3">
                ${r.attended
                        ? `<span class="inline-flex items-center gap-1 px-3 py-1.5 rounded-lg text-xs font-bold bg-green-100 text-green-700 border border-green-200"><i data-lucide="check-circle-2" class="w-3 h-3"></i> Valid√©</span>`
                        : `<span class="inline-flex items-center gap-1 px-3 py-1.5 rounded-lg text-xs font-bold bg-slate-200 text-slate-500 border border-slate-300">En attente</span>`
                    }
                
                ${state.profile.is_admin ? `
                <button onclick="adminDeleteHistory('${r.id}', '${uid}')" class="bg-white p-2 rounded-lg text-slate-300 hover:text-red-500 border border-slate-200 shadow-sm transition" title="Supprimer entr√©e">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>` : ''}
            </div>
        </div>`;
            }).join('') : `<div class="text-center py-10 text-slate-400 font-medium">Aucune mission pass√©e.</div>`;

            m.innerHTML = `
        <div class="bg-white w-full max-w-lg rounded-3xl p-6 h-[80vh] flex flex-col shadow-2xl animate-slide-up relative">
            <button onclick="this.closest('.fixed').remove()" class="absolute top-5 right-5 bg-slate-100 p-2 rounded-full hover:bg-slate-200 transition">
                <i data-lucide="x" class="w-4 h-4 text-slate-500"></i>
            </button>
            
            <h3 class="text-xl font-extrabold text-slate-900 mb-2">Historique</h3>
            <p class="text-sm text-slate-500 mb-6">Retrouvez toutes les missions pass√©es.</p>
            
            <div class="flex-1 overflow-y-auto no-scrollbar pb-4">
                ${listHtml}
            </div>
        </div>
    `;

            document.body.appendChild(m);
            lucide.createIcons();
        }

        async function adminDeleteHistory(regId, uid) {
            if (!confirm("Supprimer cette entr√©e de l'historique ? Cela annulera les heures comptabilis√©es.")) return;

            // Fermer la modale actuelle pour √©viter conflit visuel lors du rechargement
            document.querySelector('.fixed.z-50').remove();
            toggleLoader(true);

            await supabase.from('registrations').delete().eq('id', regId);

            // Recalculer les heures de l'utilisateur (optionnel mais recommand√© si tu stockes le total)
            // Ici on suppose que le total_hours est mis √† jour via trigger ou recharg√©.
            // On recharge l'historique :
            await viewUserHistory(uid);
            toggleLoader(false);
            showToast("Entr√©e supprim√©e.");
        }
        async function contactVolunteer(targetUserId, targetName) {
            toggleLoader(true);

            try {
                // 1. On cherche si une conversation "support" existe d√©j√† pour ce b√©n√©vole
                const { data: existingTickets, error: searchError } = await supabase
                    .from('tickets')
                    .select('id')
                    .eq('user_id', targetUserId)
                    .eq('category', 'support') // On ne veut pas les annonces
                    .limit(1);

                let ticketId;

                if (existingTickets && existingTickets.length > 0) {
                    // CAS A : Une conversation existe d√©j√†, on la reprend
                    ticketId = existingTickets[0].id;
                } else {
                    // CAS B : Aucune conversation, on en cr√©e une nouvelle
                    // Note : On met 'user_id' = le b√©n√©vole, pour qu'il la voie comme SA conversation
                    const { data: newTicket, error: createError } = await supabase
                        .from('tickets')
                        .insert([{
                            user_id: targetUserId,
                            subject: 'Message du Staff', // Sujet par d√©faut
                            category: 'support'
                        }])
                        .select()
                        .single();

                    if (createError) throw createError;
                    ticketId = newTicket.id;
                }

                // 2. On redirige l'Admin vers l'onglet Chat
                await setView('messages');

                // 3. On ouvre le ticket sp√©cifique (petit d√©lai pour laisser le temps √† l'UI de charger)
                setTimeout(() => {
                    openTicket(ticketId);
                }, 500);

            } catch (err) {
                console.error("Erreur contact:", err);
                showToast("Impossible d'ouvrir la conversation", "error");
            } finally {
                toggleLoader(false);
            }
        }

        async function openNewConversationModal() {
            // 1. On s'assure d'avoir la liste des utilisateurs
            if (!state.allUsers || state.allUsers.length === 0) {
                toggleLoader(true);
                const { data } = await supabase.from('profiles').select('*').order('first_name');
                state.allUsers = data || [];
                toggleLoader(false);
            }

            // 2. Cr√©ation de la modale
            const m = document.createElement('div');
            m.id = 'user-select-modal';
            m.className = 'fixed inset-0 bg-black/60 z-[80] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in';

            // On g√©n√®re la liste HTML initiale
            const generateList = (filter = '') => {
                const term = filter.toLowerCase();
                return state.allUsers
                    .filter(u =>
                        (u.first_name + ' ' + u.last_name).toLowerCase().includes(term) &&
                        u.id !== state.user.id // On ne s'√©crit pas √† soi-m√™me
                    )
                    .map(u => {
                        const name = `${u.first_name} ${u.last_name}`;
                        // √âchappement pour le onclick
                        const safeName = name.replace(/'/g, "\\'");
                        return `
                    <button onclick="selectUserForChat('${u.id}', '${safeName}')" class="w-full flex items-center gap-3 p-3 hover:bg-brand-50 rounded-xl transition group text-left border border-transparent hover:border-brand-100">
                        <div class="w-10 h-10 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center font-bold text-sm group-hover:bg-brand-200 group-hover:text-brand-700">
                            ${u.first_name[0]}
                        </div>
                        <div>
                            <div class="font-bold text-slate-800 text-sm">${u.first_name} ${u.last_name}</div>
                            <div class="text-[10px] text-slate-400 font-medium">${u.role_title || 'B√©n√©vole'}</div>
                        </div>
                        <i data-lucide="message-circle" class="w-4 h-4 ml-auto text-slate-300 group-hover:text-brand-500"></i>
                    </button>`;
                    }).join('') || '<div class="text-center text-slate-400 py-4 text-xs">Aucun b√©n√©vole trouv√©.</div>';
            };

            m.innerHTML = `
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-slide-up flex flex-col max-h-[80vh]">
                <div class="flex justify-between items-center mb-4 flex-shrink-0">
                    <h3 class="font-extrabold text-lg text-slate-900">Nouveau Message</h3>
                    <button onclick="document.getElementById('user-select-modal').remove()" class="bg-slate-50 p-2 rounded-full text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>
                
                <div class="relative mb-4 flex-shrink-0">
                    <i data-lucide="search" class="absolute left-3 top-3 w-4 h-4 text-slate-400"></i>
                    <input id="user-search-input" type="text" placeholder="Rechercher un b√©n√©vole..." class="w-full pl-10 pr-4 py-2.5 bg-slate-50 rounded-xl font-bold text-sm outline-none focus:ring-2 focus:ring-brand-500 transition">
                </div>

                <div id="user-list-container" class="flex-1 overflow-y-auto space-y-1 pr-1">
                    ${generateList()}
                </div>
            </div>
        `;

            document.body.appendChild(m);
            lucide.createIcons();

            // 3. Gestionnaire de recherche en direct
            document.getElementById('user-search-input').addEventListener('input', (e) => {
                document.getElementById('user-list-container').innerHTML = generateList(e.target.value);
                lucide.createIcons();
            });
        }

        // Fonction relais pour fermer la modale et lancer le contact
        async function selectUserForChat(uid, name) {
            document.getElementById('user-select-modal').remove();
            // On appelle votre fonction existante (cr√©√©e √† l'√©tape pr√©c√©dente)
            await contactVolunteer(uid, name);
        }

        /**
     * Ouvre une belle modale de confirmation
     * @param {string} title - Le titre en gras
     * @param {string} message - Le texte explicatif
     * @param {function} onConfirm - La fonction √† lancer si l'utilisateur dit OUI
     * @param {boolean} isDanger - Si true, le bouton sera ROUGE (suppression). Sinon BLEU.
     */
        function openConfirmModal(title, message, onConfirm, isDanger = false) {
            const m = document.createElement('div');
            m.className = 'fixed inset-0 bg-slate-900/60 z-[200] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in confirm-modal-overlay';

            // Couleurs dynamiques selon le danger
            const btnClass = isDanger
                ? 'bg-red-600 shadow-red-200 hover:bg-red-700'
                : 'bg-brand-600 shadow-brand-200 hover:bg-brand-700';

            const icon = isDanger ? 'alert-octagon' : 'help-circle';
            const iconColor = isDanger ? 'text-red-500 bg-red-50 border-red-100' : 'text-brand-600 bg-brand-50 border-brand-100';

            m.innerHTML = `
        <div class="bg-white w-full max-w-sm rounded-[2rem] p-6 shadow-2xl animate-slide-up transform transition-all">
            <div class="text-center">
                <div class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 border-4 shadow-sm ${iconColor}">
                    <i data-lucide="${icon}" class="w-8 h-8"></i>
                </div>

                <h3 class="text-xl font-extrabold text-slate-900 mb-2">${title}</h3>
                <p class="text-sm text-slate-500 mb-8 leading-relaxed px-2">${message}</p>

                <div class="flex gap-3">
                    <button id="btn-cancel" class="flex-1 py-3.5 bg-slate-100 text-slate-600 font-bold rounded-xl hover:bg-slate-200 transition">
                        Annuler
                    </button>
                    <button id="btn-confirm" class="flex-1 py-3.5 text-white font-bold rounded-xl shadow-lg active:scale-95 transition flex items-center justify-center gap-2 ${btnClass}">
                        Confirmer
                    </button>
                </div>
            </div>
        </div>
    `;

            document.body.appendChild(m);
            lucide.createIcons();

            // Gestion des clics
            // 1. Annuler
            m.querySelector('#btn-cancel').onclick = () => m.remove();

            // 2. Confirmer
            m.querySelector('#btn-confirm').onclick = () => {
                m.remove(); // On ferme
                onConfirm(); // On lance l'action
            };
        }

        function openForgotPasswordModal() {
            const m = document.createElement('div');
            m.className = 'fixed inset-0 bg-black/60 z-[200] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in';

            m.innerHTML = `
        <div class="bg-white w-full max-w-sm rounded-[2rem] p-6 shadow-2xl animate-slide-up relative">
            <button onclick="this.closest('.fixed').remove()" class="absolute top-4 right-4 bg-slate-50 p-2 rounded-full text-slate-400 hover:text-slate-600">
                <i data-lucide="x" class="w-4 h-4"></i>
            </button>

            <div class="text-center mb-6">
                <div class="w-14 h-14 bg-blue-50 text-brand-600 rounded-2xl flex items-center justify-center mx-auto mb-3 shadow-sm rotate-3">
                    <i data-lucide="key-round" class="w-7 h-7"></i>
                </div>
                <h3 class="text-xl font-extrabold text-slate-900">R√©initialisation</h3>
                <p class="text-xs text-slate-400 mt-1">Nous allons vous envoyer un lien magique.</p>
            </div>

            <form onsubmit="submitForgot(event)" class="space-y-4">
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1 mb-1 block">Votre Email</label>
                    <input id="forgot-email" type="email" required placeholder="exemple@email.com" class="w-full p-4 bg-slate-50 rounded-xl font-bold text-sm outline-none focus:ring-2 focus:ring-brand-500 transition">
                </div>
                <button type="submit" class="w-full py-3.5 bg-slate-900 text-white font-bold rounded-xl shadow-lg hover:bg-slate-800 transition">
                    Envoyer le lien
                </button>
            </form>
        </div>
    `;
            document.body.appendChild(m);
            lucide.createIcons();
        }

        // La logique qui va avec
        async function submitForgot(e) {
            e.preventDefault();
            const email = document.getElementById('forgot-email').value;
            const modal = document.querySelector('.fixed.z-\\[200\\]'); // Cible la modale

            if (!email) return;

            toggleLoader(true);
            try {
                const { error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo: window.location.href });

                toggleLoader(false);
                if (modal) modal.remove(); // On ferme la fen√™tre

                if (error) throw error;
                showToast('üì¨ Email envoy√© ! V√©rifiez vos spams.', 'success');

            } catch (err) {
                toggleLoader(false);
                showToast(err.message || 'Erreur envoi email', 'error');
            }
        }
    </script>
</body>

</html>